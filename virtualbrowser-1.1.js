// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(b,v){b.injectBaseHrefToHtml=function(c,k){var f=k.split('#')[0],d=f[n](/([^?]*\/)?(.*)/,'$2'),a=f.split('?')[0][n](/(.*\/)?.*/,'$1');c=c[n](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[n](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[n](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[n](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+a+'$3')[n](/\`<<`>>/g,'');return c};b.getResultBody=function(c){return b('<div/>').append(b(c||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var F=document.location,A='isDefaultPrevented',G='preventDefault',w='stopPropagation',s='passThrough',l='virtualBrowser',H='VBbeforeload',I='VBload',J='VBerror',K='VBloaded',L='VBdisengaged',n='replace',q='resultDOM',r='result',M=/^(https?:)?\/\//,N={'load':function(d){var a={},e,g,i=b(this),m=i.data(l),h=m.cfg,j=b.Event(H),o,B,O;if(b.isPlainObject(d)){b.extend(a,d);g=a.url;delete a.elm}else if(typeof d=='string'){g=d}else{e=b(d);a.elm=e;g=e.attr('href');g=g===v?e.attr('action'):g}g=a.url=(g==='')?F.href:g;if(m.$$empty){a.isFirst=true;delete m.$$empty}if(g){j[w]();i.trigger(j,[a]);if(!j[s]&&((j[s]===v&&e&&e[0].target&&e[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(g)&&!g.toLowerCase()[n](M,'').indexOf(F.href.toLowerCase()[n](M,'').split('/')[0])==0))){j[s]=true}j[s]&&j[G]();if(!j[A]()){var S=a.noCache=a.noCache!==v?a.noCache:h.noCache,p=h.params?[h.params]:[],x;if(e&&e.is('form')){x=e.attr('method');p.push(e.serialize());var y=m._clicked;if(y){var C=y.elm;if(C.is(':image')){var P=C[0].name;p.push(P+'.x='+Math.round(y.X));p.push(P+'.y='+Math.round(y.Y))}else{p.push(b.param(C))}delete m._clicked}var Q='multipart/form-data';j._doIframeSubmit=e.attr('enctype')==Q||e.attr('encoding')==Q||!!e.find('input:file')[0]}if(a.params){p.push((typeof a.params=='string')?a.params:b.param(a.params||{}))}p=a.params=p.join('&');x=a.method=a.method||x||'GET';i.addClass(h.loadingClass);if(h.loadmsgElm){O=setTimeout(function(){h.loadmsgMode=='replace'&&i.empty();i.append(h.loadmsgElm)},0)}var z={url:a.url.split('#')[0],data:p,type:x,cache:!S,complete:function(c,k){if(!c){return}clearTimeout(O);i.removeClass(h.loadingClass||'');a.xhr=c;a.status=k||'error';var f=!k||k=='error';if(f){i.trigger(J,[a])}else{a[r]=b.injectBaseHrefToHtml(c.responseText||'',a.url)}if(a[r]&&h.selector){a[q]=b.getResultBody(a[r]).find(h.selector)}if(!f||a[r]||a[q]){o=b.Event(I);o[w]();i.trigger(o,[a]);if(!o[A]()){B=b.Event(K);B[w]();h.loadmsgElm&&h.loadmsgElm.detach();a[q]=a[q]||b.getResultBody(a[r]).contents();i.empty().append(a[q]);m.lastRequest=a;i.trigger(B,[a]).find('form').data(l,i).bind('submit',t);delete a[q];delete a[r]}}delete a.xhr;if(h.disengage){i[l]('disengage')}}};if(j._doIframeSubmit){z=b.extend({},z);var R='if'+(new Date).getTime(),D=b('<iframe name="'+R+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),E=e.attr('action')||'',T=e.attr('target')||'';e.attr('target',R);if(h.params){e.attr('action',E+(/\?/.test(E)?'&':'?')+h.params)}D.bind('load',function(){var c='success';z.complete({fakeXHR:'iframe',responseText:'<html>'+D.contents().find('html').html()+'</html>'},c);e.attr({target:T,action:E});setTimeout(function(){D.remove()},0)})}else{b.ajax(z)}}}return j},'data':function(){return b(this).data(l)},'disengage':function(){var c=b(this);c.removeData(l).unbind('click',t).find('form').removeData(l).unbind('click',t).end().unbind([H,J,I,K].join(' ')).trigger(L).unbind(L)}},t=function(c){var k=(c.type=='submit'),f=k?b(this):b(c.target).closest('[href], input:submit, button:submit, input:image'),d=k?f.data(l):this;if(f[0]){if(!c[A]()){if(f.is('input, button')){if(!f[0].disabled){var a=b(d).data(l);if(f.is(':image')){var e=f.offset();a._clicked={elm:f,X:c.pageX-e.left,Y:c.pageY-e.top}}else if(f.is('[name]')){a._clicked={elm:f}}setTimeout(function(){delete a._clicked},0)}}else{var g=N['load'].call(d,f);if(!g[s]){!g._doIframeSubmit&&c[G]();g.isPropagationStopped()&&c[w]()}}}}},u=b.fn[l]=function(g,i){var m=this,h=typeof g=='string';if(h){var j=N[g],o;if(j){m.each(function(c){var k=j.apply(this,[].concat(i));if(!c){o=k}})}if(o!==v){return o}}else{m.each(function(){var f=b(this),d=b.extend({},u.defaults,g);b.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(c,k){c='on'+k;d[c]&&m.bind('VB'+k.toLowerCase(),d[c]);delete d[c]});d.params=(typeof d.params=='string')?d.params:b.param(d.params||{});i&&(d.url=i);if(d.loadmsgMode!='none'){var a=d.loadmsgElm||'<div class="loading" />',e=(u.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(a.charAt){a=a.replace(/%\{msg\}/g,e)}a=d.loadmsgElm=b(a);if(!a.text()){a.append(e)}}else{delete d.loadmsgElm}f.data(l,{cfg:d,$$empty:1});f.bind('click',t);if(d.url){f[l]('load',d.url)}else{f.find('form').data(l,f).bind('submit',t)}})}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
