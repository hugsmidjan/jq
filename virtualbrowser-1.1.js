// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(b,y){b.injectBaseHrefToHtml=function(d,i){var c=i.split('#')[0],e=c[p](/([^?]*\/)?(.*)/,'$2'),h=c.split('?')[0][p](/(.*\/)?.*/,'$1');d=d[p](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+e+'$3')[p](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+e.split('?')[0]+'?')[p](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[p](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+h+'$3')[p](/\`<<`>>/g,'');return d};b.getResultBody=b.getResultBody||function(d,i){var c=b.getResultBody;i=i||{};return b('<div/>').append(b(d||[]).not(i.stripFlat||c.stripFlat||'script,title,meta,link,style').find(i.stripDeep||c.stripDeep||'script,style').remove().end())};var J=document.location,D='isDefaultPrevented',K='preventDefault',z='stopPropagation',u='passThrough',q='virtualBrowser',v=q+'Bdy',L='VBbeforeload',M='VBload',N='VBerror',O='VBloaded',P='VBdisengaged',p='replace',r='resultDOM',s='result',E='data-srcattr',Q=/^(https?:)?\/\//,R={'load':function(m,o){var a={},f,l,j=b(this),k=j.data(q),g=k.cfg,n=b.Event(L),A,F,S;if(b.isPlainObject(m)){b.extend(a,m);l=a.url;delete a.elm}else if(typeof m=='string'){l=m}else{f=b(m);a.elm=f;l=f.attr('href');l=l===y?f.attr('action'):l}l=a.url=(l==='')?J.href:l;if(!k.lastRequest){a.isFirst=true}if(l){n[z]();if(k._0){a.btn=k._0}j.trigger(n,[a,k]);if(!n[u]&&((n[u]===y&&f&&f[0].target&&f[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(l)&&!l.toLowerCase()[p](Q,'').indexOf(J.href.toLowerCase()[p](Q,'').split('/')[0])==0))){n[u]=true}n[u]&&n[K]();if(!n[D]()){var X=a.noCache=a.noCache!==y?a.noCache:g.noCache,t=g.params?[g.params]:[],B;if(f&&f.is('form')){B=f.attr('method');t.push(f.serialize());var C=k._0;if(C){var G=C.elm;if(G.is(':image')){var T=G[0].name;t.push(T+'.x='+Math.round(C.X));t.push(T+'.y='+Math.round(C.Y))}else{t.push(b.param(G))}delete k._0}var U='multipart/form-data';n._1=f.attr('enctype')==U||f.attr('encoding')==U||!!f.find('input:file')[0]}if(a.params){t.push((typeof a.params=='string')?a.params:b.param(a.params||{}))}t=a.params=t.join('&');B=a.method=a.method||B||'GET';j.addClass(g.loadingClass);if(g.loadmsgElm){S=setTimeout(function(){g.loadmsgMode=='replace'&&j.empty();j.append(g.loadmsgElm)},0)}var V={url:a.url.split('#')[0],data:t,type:B,cache:!X,complete:function(c,e){if(!c){return}clearTimeout(S);j.removeClass(g.loadingClass||'');a.xhr=c;a.status=e||'error';var h=!e||e=='error';if(h){j.trigger(N,[a,k])}else{a[s]=b.injectBaseHrefToHtml(c.responseText||'',a.url);if(g.imgSuppress){a[s]=a[s].replace(/(<img[^>]*? )src=/g,'$1'+E+'=')}}if(a[s]&&g.selector){a[r]=b.getResultBody(a[s],g.stripCfg).find(g.selector)}if(!h||a[s]||a[r]){A=b.Event(M);A[z]();j.trigger(A,[a,k]);if(!A[D]()){F=b.Event(O);F[z]();g.loadmsgElm&&g.loadmsgElm.detach();a[r]=a[r]||b.getResultBody(a[s],g.stripCfg).contents();if(g.imgSuppress){a[r].find('img').add(a[r].filter('img')).attr('src',function(){var d=b(this),i=d.attr(E);d.removeAttr(E);return i})}j.empty().append(a[r]);k.lastRequest=a;j.trigger(F,[a,k]).find('form').data(v,j).bind('submit',w);delete a[r];delete a[s]}}delete a.xhr;if(g.disengage){j[q]('disengage')}}};if(n._1){var W='if'+(new Date).getTime(),H=b('<iframe name="'+W+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),I=f.attr('action')||'',Y=f.attr('target')||'';f.attr('target',W);if(g.params){f.attr('action',I+(/\?/.test(I)?'&':'?')+g.params)}H.bind('load',function(){var d='success';V.complete({fakeXHR:'iframe',responseText:'<html>'+H.contents().find('html').html()+'</html>'},d);f.attr({target:Y,action:I});setTimeout(function(){H.remove()},0)});if(!o||!o._2){f.trigger('submit',['VBiframeHack'])}}else{b.ajax(V)}}}return n},'data':function(){return b(this).data(q)},'disengage':function(){var d=b(this);d.removeData(q).removeData(v).unbind('click submit',w).find('form').removeData(v).unbind('submit',w).end().unbind([L,N,M,O].join(' ')).trigger(P).unbind(P)}},w=function(d){var i=(d.type=='submit'),c=i?b(this):b(d.target).closest('[href], input:submit, button:submit, input:image'),e=i?c.data(v):this;if(c[0]){if(!d[D]()){if(c.is('input, button')){if(!c[0].disabled){var h=b(e).data(q);if(c.is(':image')){var m=c.offset();h._0={elm:c,X:d.pageX-m.left,Y:d.pageY-m.top}}else if(c.is('[name]')){h._0={elm:c}}h._0&&setTimeout(function(){delete h._0},0)}}else{var o=R['load'].call(e,c,{_2:true});if(!o[u]){!o._1&&d[K]();o.isPropagationStopped()&&d[z]()}}}}},x=b.fn[q]=function(o,a){var f=this,l=typeof o=='string';if(l){var j=R[o],k;if(j){f.each(function(d){var i=j.apply(this,[].concat(a));if(!d){k=i}})}if(k!==y){return k}}else{f.each(function(){var c=b(this),e=b.extend({},x.defaults,o);b.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(d,i){d='on'+i;e[d]&&f.bind('VB'+i.toLowerCase(),e[d]);delete e[d]});e.params=(typeof e.params=='string')?e.params:b.param(e.params||{});a&&(e.url=a);if(e.loadmsgMode!='none'){var h=e.loadmsgElm||'<div class="loading" />',m=(x.i18n[c.closest('*[lang]').attr('lang')]||{}).loading||x.i18n.en.loading;if(h.charAt){h=h.replace(/%\{msg\}/g,m)}h=e.loadmsgElm=b(h);if(!h.text()){h.append(m)}}else{delete e.loadmsgElm}c.data(q,{cfg:e});c.bind('click',w);if(e.url){c[q]('load',e.url)}else{c.find('form').add(c.filter('form')).data(v,c).bind('submit',w)}})}return this};x.defaults={loadmsgMode:'none'};x.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
