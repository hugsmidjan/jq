// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(d,r){d.injectBaseHrefToHtml=function(b,g){var e=g.split('#')[0],f=e[l](/([^?]*\/)?(.*)/,'$2'),a=e.split('?')[0][l](/(.*\/)?.*/,'$1');b=b[l](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+f+'$3')[l](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+f.split('?')[0]+'?')[l](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[l](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+a+'$3')[l](/\`<<`>>/g,'');return b};d.getResultBody=function(b){return d('<div/>').append(d(b||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var D=document.location,y='isDefaultPrevented',E='preventDefault',u='stopPropagation',s='passThrough',m='virtualBrowser',F='VBbeforeload',G='VBload',H='VBerror',I='VBloaded',J='VBdisengaged',l='replace',p='resultDOM',q='result',K=/^(https?:)?\/\//,L={'load':function(f){var a=typeof f!='string'?d(f):r,h=d(this),k=h.data(m),j=k.cfg,i=d.Event(F),n,z,M=j.loadmsgMode,c={elm:a};if(k.$$empty){c.isFirst=true;delete k.$$empty}if(a){f=a.attr('href');f=f===r?a.attr('action'):f}f=c.url=f===''?D.href:f;if(f){i[u]();h.trigger(i,[c]);if(!i[s]&&((i[s]===r&&a&&a[0].target&&a[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(f)&&!f.toLowerCase()[l](K,'').indexOf(D.href.toLowerCase()[l](K,'').split('/')[0])==0))){i[s]=true}i[s]&&i[E]();if(!i[y]()){var R=c.noCache=c.noCache!==r?c.noCache:j.noCache,o=j.params||'',v='GET';if(a&&a.is('form')){v=a.attr('method')||v;o+='&'+a.serialize();var w=k._0;if(w){var A=w.elm;if(A.is(':image')){var N=A[0].name;o+='&'+N+'.x='+Math.round(w.X)+'&'+N+'.y='+Math.round(w.Y)}else{o+='&'+d.param(A)}delete k._0}o=o.replace(/^&+|&+$/g,'');var O='multipart/form-data';i._1=!!a.find('input:file')[0]||a.attr('enctype')==O||a.attr('encoding')==O}c.params=o;c.method=v;if(M&&M!='none'){j.loadmsgMode=='replace'&&h.empty();h.append(j.loadmsgElm)}var x={url:c.url.split('#')[0],data:o,type:v,cache:!R,complete:function(b,g){c.xhr=b;c.status=g||'error';var e=!g||g=='error';if(e){h.trigger(H,[c])}else{c[q]=d.injectBaseHrefToHtml(b.responseText||'',c.url)}if(c[q]&&j.selector){c[p]=d.getResultBody(c[q]).find(j.selector)}if(!e||c[q]||c[p]){n=d.Event(G);n[u]();h.trigger(n,[c]);if(!n[y]()){z=d.Event(I);z[u]();j.loadmsgElm.detach();c[p]=c[p]||d.getResultBody(c[q]).contents();h.empty().append(c[p]);k.lastRequest=c;h.trigger(z,[c]);delete c[p];delete c[q]}}delete c.xhr;if(j.disengage){h[m]('disengage')}}};if(!i._1){d.ajax(x)}else{x=d.extend({},x);var P='if'+(new Date).getTime(),B=d('<iframe name="'+P+'" src="about:blank" style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),S=function(){var b='success';x.complete({fakeXHR:'iframe',responseText:'<html>'+B.contents().find('html').html()+'</html>'},b);a.attr({target:T,action:C});setTimeout(function(){B.remove()},0)},C=a.attr('action')||'',T=a.attr('target')||'';a.attr('target',P);if(j.params){a.attr('action',C+(/\?/.test(C)?'&':'?')+j.params)}B.bind('load',S)}}}return i},'data':function(){return d(this).data(m)},'disengage':function(){var b=d(this);b.removeData(m).unbind('click submit',Q).unbind([F,H,G,I].join(' ')).trigger(J).unbind(J)}},Q=function(b){var g=b.type=='submit',e=d(b.target).closest(g?'form':'[href], input:submit, button:submit, input:image');if(e[0]){if(!b[y]()){if(e.is('input, button')){if(!e[0].disabled){var f=d(this).data(m);if(e.is(':image')){var a=e.offset();f._0={elm:e,X:b.pageX-a.left,Y:b.pageY-a.top}}else if(e.is('[name]')){f._0={elm:e}}setTimeout(function(){delete f._0},0)}}else{var h=L['load'].call(this,e);if(!h[s]){!h._1&&b[E]();h.isPropagationStopped()&&b[u]()}}}}},t=d.fn[m]=function(a,h){var k=this,j=typeof a=='string';if(j){var i=L[a],n;if(i){k.each(function(b){var g=i.apply(this,[].concat(h));if(!b){n=g}})}if(n!==r){return n}}else{d.each(['Beforeload','Error','Load','Loaded','Disengage'],function(b,g){b='on'+g;a[b]&&k.bind('VB'+g.toLowerCase(),a[b]);delete a[b]});a.params=typeof a.params=='string'?a.params:d.param(a.params||{});k.each(function(){var b=d(this),g=d.extend({},t.defaults,a);h&&(g.url=h);var e=g.loadmsgElm||'<div class="loading" />',f=(t.i18n[b.closest('*[lang]').attr('lang')]||{}).loading||t.i18n.en.loading;if(e.charAt){e=e.replace(/%\{msg\}/g,f)}e=g.loadmsgElm=d(e);if(!e.text()){e.append(f)}b.data(m,{cfg:g,$$empty:1})}).bind('click submit',Q);a.url&&k[m]('load',a.url)}return this};t.defaults={loadmsgMode:'none'};t.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
