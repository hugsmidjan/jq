// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(c,v){c.injectBaseHrefToHtml=function(b,e){var f=e.split('#')[0],d=f[n](/([^?]*\/)?(.*)/,'$2'),j=f.split('?')[0][n](/(.*\/)?.*/,'$1');b=b[n](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[n](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[n](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[n](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+j+'$3')[n](/\`<<`>>/g,'');return b};c.getResultBody=c.getResultBody||function(b,e){var f=c.getResultBody;e=e||{};return c('<div/>').append(c(b||[]).not(e.stripFlat||f.stripFlat||'script,title,meta,link,style').find(e.stripDeep||f.stripDeep||'script,style').remove().end())};c.imgSuppress=c.imgSuppress||function(b,e){return b.replace(/(<img[^>]*? )src=/g,'$1'+(e||C)+'=')};c.imgUnsuppress=c.imgUnsuppress||function(f,d){d=d||C;f.find('img').add(f.filter('img')).attr('src',function(){var b=c(this),e=b.attr(d);b.removeAttr(d);return e})};var D=document.location,y='isDefaultPrevented',E='preventDefault',F='stopPropagation',t='passThrough',m='virtualBrowser',G='VBbeforeload',H='VBload',I='VBerror',J='VBloaded',K='VBdisengaged',n='replace',r='resultDOM',p='result',C='data-srcAttr',L=/^(https?:)?\/\//,u=function(e,f,d,j){var a=c.Event(e);f.one(e,function(b){b[F]()}).trigger(a,[d,j]);return a};_2={'load':function(d,j){var a={},g,k,i=c(this),l=i.data(m),h=l.cfg,s;if(c.isPlainObject(d)){c.extend(a,d);k=a.url;delete a.elm}else if(typeof d=='string'){k=d}else{g=c(d);a.elm=g;k=g.attr('href');k=k===v?g.attr('action'):k}k=a.url=(k==='')?D.href:k;if(!l.lastRequest){a.isFirst=true}if(k){if(l._0){a.btn=l._0}var o=u(G,i,a,l);if(!o[t]&&((o[t]===v&&g&&g[0].target&&g[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(k)&&!k.toLowerCase()[n](L,'').indexOf(D.href.toLowerCase()[n](L,'').split('/')[0])==0))){o[t]=true}o[t]&&o[E]();if(!o[y]()){var Q=a.noCache=a.noCache!==v?a.noCache:h.noCache,q=h.params?[h.params]:[],w;if(g&&g.is('form')){w=g.attr('method');q.push(g.serialize());var x=l._0;if(x){var z=x.elm;if(z.is(':image')){var M=z[0].name;q.push(M+'.x='+Math.round(x.X));q.push(M+'.y='+Math.round(x.Y))}else{q.push(c.param(z))}delete l._0}var N='multipart/form-data';o._3=g.attr('enctype')==N||g.attr('encoding')==N||!!g.find('input:file')[0]}if(a.params){q.push((typeof a.params=='string')?a.params:c.param(a.params||{}))}q=a.params=q.join('&');w=a.method=a.method||w||'GET';i.addClass(h.loadingClass);if(h.loadmsgElm){s=setTimeout(function(){h.loadmsgMode=='replace'&&i.empty();i.append(h.loadmsgElm)},0)}var O={url:a.url.split('#')[0],data:q,type:w,cache:!Q,complete:function(b,e){if(!b){return}clearTimeout(s);i.removeClass(h.loadingClass||'');a.xhr=b;a.status=e||'error';var f=!e||e=='error';if(f){u(I,i,a,l)}else{a[p]=c.injectBaseHrefToHtml(b.responseText||'',a.url);if(h.imgSuppress){a[p]=c.imgSuppress(a[p])}}if(a[p]&&h.selector){a[r]=c.getResultBody(a[p],h.stripCfg).find(h.selector)}if(!f||a[p]||a[r]){if(!u(H,i,a,l)[y]()){h.loadmsgElm&&h.loadmsgElm.detach();a[r]=a[r]||c.getResultBody(a[p],h.stripCfg).contents();if(h.imgSuppress){c.imgUnsuppress(a[r])}i.empty().append(a[r]);l.lastRequest=a;u(J,i,a,l);i.find('form').bind('submit.vb'+i.data('VBid'),c.proxy(_1,i[0]));delete a[r];delete a[p]}}delete a.xhr;if(h.disengage){i[m]('disengage')}}};if(o._3){var P='if'+(new Date).getTime(),A=c('<iframe name="'+P+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),B=g.attr('action')||'',R=g.attr('target')||'';g.attr('target',P);if(h.params){g.attr('action',B+(/\?/.test(B)?'&':'?')+h.params)}A.bind('load',function(){var b='success';O.complete({fakeXHR:'iframe',responseText:'<html>'+A.contents().find('html').html()+'</html>'},b);g.attr({target:R,action:B});setTimeout(function(){A.remove()},0)});if(!j||!j._4){g.trigger('submit',['VBiframeHack'])}}else{c.ajax(O)}}return o}},'data':function(){return c(this).data(m)},'disengage':function(){var b=c(this);b.removeData(m).unbind('click submit',_1).find('form').unbind('submit.vb'+b.data('VBid'),_1).end().unbind([G,I,H,J].join(' '));u(K,b);b.unbind(K)}},_1=function(b){if(!b[y]()&&!b[m+'Handled']){var e=c(b.target).closest((b.type=='submit')?'[action]':'input:submit, button:submit, input:image, [href]',this);if(e[0]){var f=c(this);if(e.is('input, button')){if(!e[0].disabled){var d=f.data(m);if(e.is(':image')){var j=e.offset();d._0={elm:e,X:b.pageX-j.left,Y:b.pageY-j.top}}else if(e.is('[name]')){d._0={elm:e}}d._0&&setTimeout(function(){delete d._0},0)}}else{var a=_2['load'].call(f[0],e,{_4:true});if(!a[t]){!a._3&&b[E]();a.isPropagationStopped()&&b[F]();b[m+'Handled']=true}}}}},fnVB=c.fn[m]=function(g,k){var i=this,l=typeof g=='string';if(l){var h=_2[g],s;if(h){i.each(function(b){var e=h.apply(this,[].concat(k));if(!b){s=e}})}if(s!==v){return s}}else{i.each(function(){var f=c(this),d=c.extend({},fnVB.defaults,g);c.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(b,e){b='on'+e;d[b]&&i.bind('VB'+e.toLowerCase(),d[b]);delete d[b]});d.params=(typeof d.params=='string')?d.params:c.param(d.params||{});k&&(d.url=k);if(d.loadmsgMode!='none'){var j=d.loadmsgElm||'<div class="loading" />',a=(fnVB.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||fnVB.i18n.en.loading;if(j.charAt){j=j.replace(/%\{msg\}/g,a)}j=d.loadmsgElm=c(j);if(!j.text()){j.append(a)}}else{delete d.loadmsgElm}f.data(m,{cfg:d});f.bind('click',_1);f.data('VBid',(new Date()).getTime());if(d.url){f[m]('load',d.url)}else{f.find('form').add(f.filter('form')).bind('submit.vb'+f.data('VBid'),c.proxy(_1,f[0]))}})}return this};fnVB.defaults={loadmsgMode:'none'};fnVB.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
