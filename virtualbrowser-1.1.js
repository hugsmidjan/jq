// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(e,s){e.injectBaseHrefToHtml=function(d,j){var f=j.split('#')[0],a=f[l](/([^?]*\/)?(.*)/,'$2'),c=f.split('?')[0][l](/(.*\/)?.*/,'$1');d=d[l](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+a+'$3')[l](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+a.split('?')[0]+'?')[l](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[l](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+c+'$3')[l](/\`<<`>>/g,'');return d};e.getResultBody=function(d){return e('<div/>').append(e(d||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var E=document.location,A='isDefaultPrevented',F='preventDefault',v='stopPropagation',t='passThrough',m='virtualBrowser',G='VBbeforeload',H='VBload',I='VBerror',J='VBloaded',K='VBdisengaged',l='replace',o='resultDOM',p='result',L=/^(https?:)?\/\//,M={'load':function(a){var c=typeof a!='string'?e(a):s,g=e(this),k=g.data(m),h=k.cfg,i=e.Event(G),q,r,b={elm:c},N;if(k.$$empty){b.isFirst=true;delete k.$$empty}if(c){a=c.attr('href');a=a===s?c.attr('action'):a}a=b.url=a===''?E.href:a;if(a){i[v]();g.trigger(i,[b]);if(!i[t]&&((i[t]===s&&c&&c[0].target&&c[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(a)&&!a.toLowerCase()[l](L,'').indexOf(E.href.toLowerCase()[l](L,'').split('/')[0])==0))){i[t]=true}i[t]&&i[F]();if(!i[A]()){var R=b.noCache=b.noCache!==s?b.noCache:h.noCache,n=h.params||'',w='GET';if(c&&c.is('form')){w=c.attr('method')||w;n+='&'+c.serialize();var x=k._0;if(x){var B=x.elm;if(B.is(':image')){var O=B[0].name;n+='&'+O+'.x='+Math.round(x.X)+'&'+O+'.y='+Math.round(x.Y)}else{n+='&'+e.param(B)}delete k._0}n=n.replace(/^&+|&+$/g,'');var P='multipart/form-data';i._1=c.attr('enctype')==P||c.attr('encoding')==P||!!c.find('input:file')[0]}b.params=n;b.method=w;g.addClass(h.loadingClass);if(h.loadmsgElm){N=setTimeout(function(){h.loadmsgMode=='replace'&&g.empty();g.append(h.loadmsgElm)},0)}var y={url:b.url.split('#')[0],data:n,type:w,cache:!R,complete:function(d,j){if(!d){return}clearTimeout(N);g.removeClass(h.loadingClass||'');b.xhr=d;b.status=j||'error';var f=!j||j=='error';if(f){g.trigger(I,[b])}else{b[p]=e.injectBaseHrefToHtml(d.responseText||'',b.url)}if(b[p]&&h.selector){b[o]=e.getResultBody(b[p]).find(h.selector)}if(!f||b[p]||b[o]){q=e.Event(H);q[v]();g.trigger(q,[b]);if(!q[A]()){r=e.Event(J);r[v]();h.loadmsgElm&&h.loadmsgElm.detach();b[o]=b[o]||e.getResultBody(b[p]).contents();g.empty().append(b[o]);k.lastRequest=b;g.trigger(r,[b]);delete b[o];delete b[p]}}delete b.xhr;if(h.disengage){g[m]('disengage')}}};if(!i._1){e.ajax(y)}else{y=e.extend({},y);var Q='if'+(new Date).getTime(),C=e('<iframe name="'+Q+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),D=c.attr('action')||'',S=c.attr('target')||'';c.attr('target',Q);if(h.params){c.attr('action',D+(/\?/.test(D)?'&':'?')+h.params)}C.bind('load',function(){var d='success';y.complete({fakeXHR:'iframe',responseText:'<html>'+C.contents().find('html').html()+'</html>'},d);c.attr({target:S,action:D});setTimeout(function(){C.remove()},0)})}}}return i},'data':function(){return e(this).data(m)},'disengage':function(){var d=e(this);d.removeData(m).unbind('click',z).find('form').unbind('click',z).end().unbind([G,I,H,J].join(' ')).trigger(K).unbind(K)}},z=function(d){var j=this,f=e(d.target).closest((d.type=='submit')?'form':'[href], input:submit, button:submit, input:image');if(f[0]){if(!d[A]()){if(f.is('input, button')){if(!f[0].disabled){var a=e(j).data(m);if(f.is(':image')){var c=f.offset();a._0={elm:f,X:d.pageX-c.left,Y:d.pageY-c.top}}else if(f.is('[name]')){a._0={elm:f}}setTimeout(function(){delete a._0},0)}}else{var g=M['load'].call(j,f);if(!g[t]){!g._1&&d[F]();g.isPropagationStopped()&&d[v]()}}}}},u=e.fn[m]=function(k,h){var i=this,q=typeof k=='string';if(q){var r=M[k],b;if(r){i.each(function(d){var j=r.apply(this,[].concat(h));if(!d){b=j}})}if(b!==s){return b}}else{i.each(function(){var f=e(this),a=e.extend({},u.defaults,k);e.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(d,j){d='on'+j;a[d]&&i.bind('VB'+j.toLowerCase(),a[d]);delete a[d]});a.params=typeof a.params=='string'?a.params:e.param(a.params||{});h&&(a.url=h);if(a.loadmsgMode!='none'){var c=a.loadmsgElm||'<div class="loading" />',g=(u.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(c.charAt){c=c.replace(/%\{msg\}/g,g)}c=a.loadmsgElm=e(c);if(!c.text()){c.append(g)}}else{delete a.loadmsgElm}f.data(m,{cfg:a,$$empty:1});a.url&&f[m]('load',a.url)}).bind('click',z).find('form').bind('submit',z)}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
