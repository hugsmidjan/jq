// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(b,v){b.injectBaseHrefToHtml=function(c,h){var f=h.split('#')[0],e=f[o](/([^?]*\/)?(.*)/,'$2'),i=f.split('?')[0][o](/(.*\/)?.*/,'$1');c=c[o](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+e+'$3')[o](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+e.split('?')[0]+'?')[o](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[o](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+i+'$3')[o](/\`<<`>>/g,'');return c};b.getResultBody=b.getResultBody||function(c,h){var f=b.getResultBody;h=h||{};return b('<div/>').append(b(c||[]).not(h.stripFlat||f.stripFlat||'script,title,meta,link,style').find(h.stripDeep||f.stripDeep||'script,style').remove().end())};var F=document.location,A='isDefaultPrevented',G='preventDefault',w='stopPropagation',s='passThrough',m='virtualBrowser',H='VBbeforeload',I='VBload',J='VBerror',K='VBloaded',L='VBdisengaged',o='replace',q='resultDOM',r='result',M=/^(https?:)?\/\//,N={'load':function(e,i){var a={},d,j,k=b(this),n=k.data(m),g=n.cfg,l=b.Event(H),x,B,O;if(b.isPlainObject(e)){b.extend(a,e);j=a.url;delete a.elm}else if(typeof e=='string'){j=e}else{d=b(e);a.elm=d;j=d.attr('href');j=j===v?d.attr('action'):j}j=a.url=(j==='')?F.href:j;if(n.$$empty){a.isFirst=true;delete n.$$empty}if(j){l[w]();if(n._0){a.btn=n._0}k.trigger(l,[a]);if(!l[s]&&((l[s]===v&&d&&d[0].target&&d[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(j)&&!j.toLowerCase()[o](M,'').indexOf(F.href.toLowerCase()[o](M,'').split('/')[0])==0))){l[s]=true}l[s]&&l[G]();if(!l[A]()){var T=a.noCache=a.noCache!==v?a.noCache:g.noCache,p=g.params?[g.params]:[],y;if(d&&d.is('form')){y=d.attr('method');p.push(d.serialize());var z=n._0;if(z){var C=z.elm;if(C.is(':image')){var P=C[0].name;p.push(P+'.x='+Math.round(z.X));p.push(P+'.y='+Math.round(z.Y))}else{p.push(b.param(C))}delete n._0}var Q='multipart/form-data';l._1=d.attr('enctype')==Q||d.attr('encoding')==Q||!!d.find('input:file')[0]}if(a.params){p.push((typeof a.params=='string')?a.params:b.param(a.params||{}))}p=a.params=p.join('&');y=a.method=a.method||y||'GET';k.addClass(g.loadingClass);if(g.loadmsgElm){O=setTimeout(function(){g.loadmsgMode=='replace'&&k.empty();k.append(g.loadmsgElm)},0)}var R={url:a.url.split('#')[0],data:p,type:y,cache:!T,complete:function(c,h){if(!c){return}clearTimeout(O);k.removeClass(g.loadingClass||'');a.xhr=c;a.status=h||'error';var f=!h||h=='error';if(f){k.trigger(J,[a])}else{a[r]=b.injectBaseHrefToHtml(c.responseText||'',a.url)}if(a[r]&&g.selector){a[q]=b.getResultBody(a[r],g.stripCfg).find(g.selector)}if(!f||a[r]||a[q]){x=b.Event(I);x[w]();k.trigger(x,[a]);if(!x[A]()){B=b.Event(K);B[w]();g.loadmsgElm&&g.loadmsgElm.detach();a[q]=a[q]||b.getResultBody(a[r],g.stripCfg).contents();k.empty().append(a[q]);n.lastRequest=a;k.trigger(B,[a]).find('form').data(m,k).bind('submit',t);delete a[q];delete a[r]}}delete a.xhr;if(g.disengage){k[m]('disengage')}}};if(l._1){var S='if'+(new Date).getTime(),D=b('<iframe name="'+S+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),E=d.attr('action')||'',U=d.attr('target')||'';d.attr('target',S);if(g.params){d.attr('action',E+(/\?/.test(E)?'&':'?')+g.params)}D.bind('load',function(){var c='success';R.complete({fakeXHR:'iframe',responseText:'<html>'+D.contents().find('html').html()+'</html>'},c);d.attr({target:U,action:E});setTimeout(function(){D.remove()},0)});if(!i||!i._2){d.trigger('submit',['VBiframeHack'])}}else{b.ajax(R)}}}return l},'data':function(){return b(this).data(m)},'disengage':function(){var c=b(this);c.removeData(m).unbind('click',t).find('form').removeData(m).unbind('click',t).end().unbind([H,J,I,K].join(' ')).trigger(L).unbind(L)}},t=function(c){var h=(c.type=='submit'),f=h?b(this):b(c.target).closest('[href], input:submit, button:submit, input:image'),e=h?f.data(m):this;if(f[0]){if(!c[A]()){if(f.is('input, button')){if(!f[0].disabled){var i=b(e).data(m);if(f.is(':image')){var a=f.offset();i._0={elm:f,X:c.pageX-a.left,Y:c.pageY-a.top}}else if(f.is('[name]')){i._0={elm:f}}i._0&&setTimeout(function(){delete i._0},0)}}else{var d=N['load'].call(e,f,{_2:true});if(!d[s]){!d._1&&c[G]();d.isPropagationStopped()&&c[w]()}}}}},u=b.fn[m]=function(d,j){var k=this,n=typeof d=='string';if(n){var g=N[d],l;if(g){k.each(function(c){var h=g.apply(this,[].concat(j));if(!c){l=h}})}if(l!==v){return l}}else{k.each(function(){var f=b(this),e=b.extend({},u.defaults,d);b.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(c,h){c='on'+h;e[c]&&k.bind('VB'+h.toLowerCase(),e[c]);delete e[c]});e.params=(typeof e.params=='string')?e.params:b.param(e.params||{});j&&(e.url=j);if(e.loadmsgMode!='none'){var i=e.loadmsgElm||'<div class="loading" />',a=(u.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(i.charAt){i=i.replace(/%\{msg\}/g,a)}i=e.loadmsgElm=b(i);if(!i.text()){i.append(a)}}else{delete e.loadmsgElm}f.data(m,{cfg:e,$$empty:1});f.bind('click',t);if(e.url){f[m]('load',e.url)}else{f.find('form').data(m,f).bind('submit',t)}})}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
