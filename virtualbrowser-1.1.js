// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(e,s){e.injectBaseHrefToHtml=function(d,k){var f=k.split('#')[0],a=f[m](/([^?]*\/)?(.*)/,'$2'),b=f.split('?')[0][m](/(.*\/)?.*/,'$1');d=d[m](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+a+'$3')[m](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+a.split('?')[0]+'?')[m](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[m](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+b+'$3')[m](/\`<<`>>/g,'');return d};e.getResultBody=function(d){return e('<div/>').append(e(d||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var E=document.location,A='isDefaultPrevented',F='preventDefault',v='stopPropagation',t='passThrough',l='virtualBrowser',G='VBbeforeload',H='VBload',I='VBerror',J='VBloaded',K='VBdisengaged',m='replace',o='resultDOM',p='result',L=/^(https?:)?\/\//,M={'load':function(a){var b=typeof a!='string'?e(a):s,g=e(this),j=g.data(l),h=j.cfg,i=e.Event(G),q,r,c={elm:b},N;if(j.$$empty){c.isFirst=true;delete j.$$empty}if(b){a=b.attr('href');a=a===s?b.attr('action'):a}a=c.url=a===''?E.href:a;if(a){i[v]();g.trigger(i,[c]);if(!i[t]&&((i[t]===s&&b&&b[0].target&&b[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(a)&&!a.toLowerCase()[m](L,'').indexOf(E.href.toLowerCase()[m](L,'').split('/')[0])==0))){i[t]=true}i[t]&&i[F]();if(!i[A]()){var R=c.noCache=c.noCache!==s?c.noCache:h.noCache,n=h.params||'',w='GET';if(b&&b.is('form')){w=b.attr('method')||w;n+='&'+b.serialize();var x=j._0;if(x){var B=x.elm;if(B.is(':image')){var O=B[0].name;n+='&'+O+'.x='+Math.round(x.X)+'&'+O+'.y='+Math.round(x.Y)}else{n+='&'+e.param(B)}delete j._0}n=n.replace(/^&+|&+$/g,'');var P='multipart/form-data';i._1=b.attr('enctype')==P||b.attr('encoding')==P||!!b.find('input:file')[0]}c.params=n;c.method=w;g.addClass(h.loadingClass);if(h.loadmsgElm){N=setTimeout(function(){h.loadmsgMode=='replace'&&g.empty();g.append(h.loadmsgElm)},0)}var y={url:c.url.split('#')[0],data:n,type:w,cache:!R,complete:function(d,k){if(!d){return}clearTimeout(N);g.removeClass(h.loadingClass||'');c.xhr=d;c.status=k||'error';var f=!k||k=='error';if(f){g.trigger(I,[c])}else{c[p]=e.injectBaseHrefToHtml(d.responseText||'',c.url)}if(c[p]&&h.selector){c[o]=e.getResultBody(c[p]).find(h.selector)}if(!f||c[p]||c[o]){q=e.Event(H);q[v]();g.trigger(q,[c]);if(!q[A]()){r=e.Event(J);r[v]();h.loadmsgElm&&h.loadmsgElm.detach();c[o]=c[o]||e.getResultBody(c[p]).contents();g.empty().append(c[o]);j.lastRequest=c;g.trigger(r,[c]).find('form').data(l,g).bind('submit',z);delete c[o];delete c[p]}}delete c.xhr;if(h.disengage){g[l]('disengage')}}};if(!i._1){e.ajax(y)}else{y=e.extend({},y);var Q='if'+(new Date).getTime(),C=e('<iframe name="'+Q+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),D=b.attr('action')||'',S=b.attr('target')||'';b.attr('target',Q);if(h.params){b.attr('action',D+(/\?/.test(D)?'&':'?')+h.params)}C.bind('load',function(){var d='success';y.complete({fakeXHR:'iframe',responseText:'<html>'+C.contents().find('html').html()+'</html>'},d);b.attr({target:S,action:D});setTimeout(function(){C.remove()},0)})}}}return i},'data':function(){return e(this).data(l)},'disengage':function(){var d=e(this);d.removeData(l).unbind('click',z).find('form').removeData(l).unbind('click',z).end().unbind([G,I,H,J].join(' ')).trigger(K).unbind(K)}},z=function(d){var k=(d.type=='submit'),f=k?e(this):e(d.target).closest('[href], input:submit, button:submit, input:image'),a=k?f.data(l):this;if(f[0]){if(!d[A]()){if(f.is('input, button')){if(!f[0].disabled){var b=e(a).data(l);if(f.is(':image')){var g=f.offset();b._0={elm:f,X:d.pageX-g.left,Y:d.pageY-g.top}}else if(f.is('[name]')){b._0={elm:f}}setTimeout(function(){delete b._0},0)}}else{var j=M['load'].call(a,f);if(!j[t]){!j._1&&d[F]();j.isPropagationStopped()&&d[v]()}}}}},u=e.fn[l]=function(j,h){var i=this,q=typeof j=='string';if(q){var r=M[j],c;if(r){i.each(function(d){var k=r.apply(this,[].concat(h));if(!d){c=k}})}if(c!==s){return c}}else{i.each(function(){var f=e(this),a=e.extend({},u.defaults,j);e.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(d,k){d='on'+k;a[d]&&i.bind('VB'+k.toLowerCase(),a[d]);delete a[d]});a.params=typeof a.params=='string'?a.params:e.param(a.params||{});h&&(a.url=h);if(a.loadmsgMode!='none'){var b=a.loadmsgElm||'<div class="loading" />',g=(u.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(b.charAt){b=b.replace(/%\{msg\}/g,g)}b=a.loadmsgElm=e(b);if(!b.text()){b.append(g)}}else{delete a.loadmsgElm}f.data(l,{cfg:a,$$empty:1});a.url&&f[l]('load',a.url)}).bind('click',z)}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
