// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(d,p){d.injectBaseHrefToHtml=function(e,j){var a=j.split('#')[0],c=a[k](/([^?]*\/)?(.*)/,'$2'),b=a.split('?')[0][k](/(.*\/)?.*/,'$1');e=e[k](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+c+'$3')[k](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+c.split('?')[0]+'?')[k](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[k](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+b+'$3')[k](/\`<<`>>/g,'');return e};d.getResultBody=function(e){return d('<div/>').append(d(e||[]).not('script,title,meta,link,style').find('script,style').remove().end())};var D=document.location,w='isDefaultPrevented',E='preventDefault',s='stopPropagation',q='passThrough',l='virtualBrowser',x='VBbeforeload',y='VBdisengaged',z='VBload',A='VBloaded',k='replace',F=/^(https?:)?\/\//,G={'load':function(a){var c=typeof a!='string'?d(a):p,b=d(this),h=b.data(l),g=h.cfg,i=d.Event(x),m,n,H=g.loadmsgMode,f={elm:c};if(h.$$empty){f.isFirst=true;delete h.$$empty}if(c){a=c.attr('href');a=a===p?c.attr('action'):a}a=f.url=a===''?D.href:a;if(a){i[s]();b.trigger(i,f);if(!i[q]&&((i[q]===p&&c&&c[0].target&&c[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(a)&&!a.toLowerCase()[k](F,'').indexOf(D.href.toLowerCase()[k](F,'').split('/')[0])==0))){i[q]=true}i[q]&&i[E]();if(!i[w]()){var M=f.noCache=f.noCache!==p?f.noCache:g.noCache,o=g.params||'',t='GET';if(c&&c.is('form')){t=c.attr('method')||t;o+='&'+c.serialize();var u=h._0;if(u){var B=u.elm;if(B.is(':image')){var I=B[0].name;o+='&'+I+'.x='+Math.round(u.X)+'&'+I+'.y='+Math.round(u.Y)}else{o+='&'+d.param(B)}delete h._0}o=o.replace(/^&+/,'');var J='multipart/form-data';i._1=!!c.find('input:file')[0]||c.attr('enctype')==J||c.attr('encoding')==J}f.params=o;f.method=t;if(H&&H!='none'){g.loadmsgMode=='replace'&&b.empty();b.append(g.loadmsgElm)}var v={url:f.url.split('#')[0],data:o,type:t,cache:!M,complete:function(e,j){f.result=d.injectBaseHrefToHtml(e.responseText,f.url);f.xhr=e;f.status=j;if(g.selector){f.resultDOM=d.getResultBody(f.result).find(g.selector)}m=d.Event(z);m[s]();b.trigger(m,f);if(!m[w]()){n=d.Event(A);n[s]();g.loadmsgElm.detach();f.resultDOM=f.resultDOM||d.getResultBody(f.result).contents();b.empty().append(f.resultDOM);h.lastRequest=f;b.trigger(n,f);delete f.resultDOM;delete f.result;delete f.xhr}if(g.disengage){b[l]('disengage')}}};if(!i._1){d.ajax(v)}else{v=d.extend({},v);var K='if'+(new Date).getTime(),C=d('<iframe name="'+K+'" src="about:blank" style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),N=function(){var e='success';v.complete({fakeXHR:'iframe',responseText:'<html>'+C.contents().find('html').html()+'</html>'},e);c.attr('target',O);setTimeout(function(){C.remove()},0)},O=c.attr('target');c.attr('target',K);C.bind('load',N)}}}return i},'data':function(){return d(this).data(l)},'disengage':function(){var e=d(this);e.removeData(l).unbind('click submit',L).unbind(z+' '+A+' '+x).trigger(y).unbind(y)}},L=function(e){var j=e.type=='submit',a=d(e.target).closest(j?'form':'[href], input:submit, button:submit, input:image');if(a[0]){if(!e[w]()){if(!a.is('input, button')){var c=G['load'].call(this,a);if(!c[q]){!c._1&&e[E]();c.isPropagationStopped()&&e[s]()}}else if(!a[0].disabled){var b=d(this).data(l);_0=b._0={elm:a};if(a.is(':image')){var h=a.offset();_0.X=e.pageX-h.left;_0.Y=e.pageY-h.top}setTimeout(function(){delete b._0},0)}}}},r=d.fn[l]=function(b,h){var g=this,i=typeof b=='string';if(i){var m=G[b],n;if(m){g.each(function(e){var j=m.apply(this,[].concat(h));if(!e){n=j}})}if(n!==p){return n}}else{g.each(function(){var e=d(this),j=d.extend({},r.defaults,b);h&&(j.url=h);var a=j.loadmsgElm||'<div class="loading" />',c=(r.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||r.i18n.en.loading;if(a.charAt){a=a.replace(/%\{msg\}/g,c)}a=j.loadmsgElm=d(a);if(!a.text()){a.append(c)}e.data(l,{cfg:j,$$empty:1})}).bind('click submit',L);b.onLoad&&g.bind(z,b.onLoad);b.onLoaded&&g.bind(A,b.onLoaded);b.onBeforeload&&g.bind(x,b.onBeforeload);b.onDisengaged&&g.bind(y,b.onDisengaged);b.params=typeof b.params=='string'?b.params:d.param(b.params||{});b.url&&g[l]('load',b.url)}return this};r.defaults={loadmsgMode:'none'};r.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
