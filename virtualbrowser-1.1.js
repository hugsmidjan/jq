// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(c,x){c.injectBaseHrefToHtml=function(b,i){var d=i.split('#')[0],e=d[p](/([^?]*\/)?(.*)/,'$2'),g=d.split('?')[0][p](/(.*\/)?.*/,'$1');b=b[p](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+e+'$3')[p](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+e.split('?')[0]+'?')[p](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[p](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+g+'$3')[p](/\`<<`>>/g,'');return b};c.getResultBody=c.getResultBody||function(b,i){var d=c.getResultBody;i=i||{};return c('<div/>').append(c(b||[]).not(i.stripFlat||d.stripFlat||'script,title,meta,link,style').find(i.stripDeep||d.stripDeep||'script,style').remove().end())};var F=document.location,A='isDefaultPrevented',G='preventDefault',S='stopPropagation',u='passThrough',m='virtualBrowser',v=m+'Bdy',H='VBbeforeload',I='VBload',J='VBerror',K='VBloaded',L='VBdisengaged',p='replace',r='resultDOM',s='result',B='data-srcattr',M=/^(https?:)?\/\//,w=function(b,i,d,e){var g=c.Event(b);g.stopPropagation();i.trigger(g,[d,e]);return g};_2={'load':function(n,o){var a={},f,l,j=c(this),k=j.data(m),h=k.cfg,N;if(c.isPlainObject(n)){c.extend(a,n);l=a.url;delete a.elm}else if(typeof n=='string'){l=n}else{f=c(n);a.elm=f;l=f.attr('href');l=l===x?f.attr('action'):l}l=a.url=(l==='')?F.href:l;if(!k.lastRequest){a.isFirst=true}if(l){if(k._0){a.btn=k._0}var q=w(H,j,a,k);if(!q[u]&&((q[u]===x&&f&&f[0].target&&f[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(l)&&!l.toLowerCase()[p](M,'').indexOf(F.href.toLowerCase()[p](M,'').split('/')[0])==0))){q[u]=true}q[u]&&q[G]();if(!q[A]()){var T=a.noCache=a.noCache!==x?a.noCache:h.noCache,t=h.params?[h.params]:[],y;if(f&&f.is('form')){y=f.attr('method');t.push(f.serialize());var z=k._0;if(z){var C=z.elm;if(C.is(':image')){var O=C[0].name;t.push(O+'.x='+Math.round(z.X));t.push(O+'.y='+Math.round(z.Y))}else{t.push(c.param(C))}delete k._0}var P='multipart/form-data';q._3=f.attr('enctype')==P||f.attr('encoding')==P||!!f.find('input:file')[0]}if(a.params){t.push((typeof a.params=='string')?a.params:c.param(a.params||{}))}t=a.params=t.join('&');y=a.method=a.method||y||'GET';j.addClass(h.loadingClass);if(h.loadmsgElm){N=setTimeout(function(){h.loadmsgMode=='replace'&&j.empty();j.append(h.loadmsgElm)},0)}var Q={url:a.url.split('#')[0],data:t,type:y,cache:!T,complete:function(d,e){if(!d){return}clearTimeout(N);j.removeClass(h.loadingClass||'');a.xhr=d;a.status=e||'error';var g=!e||e=='error';if(g){w(J,j,a,k)}else{a[s]=c.injectBaseHrefToHtml(d.responseText||'',a.url);if(h.imgSuppress){a[s]=a[s].replace(/(<img[^>]*? )src=/g,'$1'+B+'=')}}if(a[s]&&h.selector){a[r]=c.getResultBody(a[s],h.stripCfg).find(h.selector)}if(!g||a[s]||a[r]){if(!w(I,j,a,k)[A]()){h.loadmsgElm&&h.loadmsgElm.detach();a[r]=a[r]||c.getResultBody(a[s],h.stripCfg).contents();if(h.imgSuppress){a[r].find('img').add(a[r].filter('img')).attr('src',function(){var b=c(this),i=b.attr(B);b.removeAttr(B);return i})}j.empty().append(a[r]);k.lastRequest=a;w(K,j,a,k);j.find('form').data(v,j).bind('submit',_1);delete a[r];delete a[s]}}delete a.xhr;if(h.disengage){j[m]('disengage')}}};if(q._3){var R='if'+(new Date).getTime(),D=c('<iframe name="'+R+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),E=f.attr('action')||'',U=f.attr('target')||'';f.attr('target',R);if(h.params){f.attr('action',E+(/\?/.test(E)?'&':'?')+h.params)}D.bind('load',function(){var b='success';Q.complete({fakeXHR:'iframe',responseText:'<html>'+D.contents().find('html').html()+'</html>'},b);f.attr({target:U,action:E});setTimeout(function(){D.remove()},0)});if(!o||!o._4){f.trigger('submit',['VBiframeHack'])}}else{c.ajax(Q)}}return q}},'data':function(){return c(this).data(m)},'disengage':function(){var b=c(this);b.removeData(m).removeData(v).unbind('click submit',_1).find('form').removeData(v).unbind('submit',_1).end().unbind([H,J,I,K].join(' '));w(L,b);b.unbind(L)}},_1=function(b){if(!b[m+'Handled']){var i=(b.type=='submit'),d=i?c(this):c(b.target).closest('[href], input:submit, button:submit, input:image'),e=i?d.data(v):this;if(d[0]){if(!b[A]()){if(d.is('input, button')){if(!d[0].disabled){var g=c(e).data(m);if(d.is(':image')){var n=d.offset();g._0={elm:d,X:b.pageX-n.left,Y:b.pageY-n.top}}else if(d.is('[name]')){g._0={elm:d}}g._0&&setTimeout(function(){delete g._0},0)}}else{var o=_2['load'].call(e,d,{_4:true});if(!o[u]){!o._3&&b[G]();o.isPropagationStopped()&&b[S]();b[m+'Handled']=true}}}}}},fnVB=c.fn[m]=function(o,a){var f=this,l=typeof o=='string';if(l){var j=_2[o],k;if(j){f.each(function(b){var i=j.apply(this,[].concat(a));if(!b){k=i}})}if(k!==x){return k}}else{f.each(function(){var d=c(this),e=c.extend({},fnVB.defaults,o);c.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(b,i){b='on'+i;e[b]&&f.bind('VB'+i.toLowerCase(),e[b]);delete e[b]});e.params=(typeof e.params=='string')?e.params:c.param(e.params||{});a&&(e.url=a);if(e.loadmsgMode!='none'){var g=e.loadmsgElm||'<div class="loading" />',n=(fnVB.i18n[d.closest('*[lang]').attr('lang')]||{}).loading||fnVB.i18n.en.loading;if(g.charAt){g=g.replace(/%\{msg\}/g,n)}g=e.loadmsgElm=c(g);if(!g.text()){g.append(n)}}else{delete e.loadmsgElm}d.data(m,{cfg:e});d.bind('click',_1);if(e.url){d[m]('load',e.url)}else{d.find('form').add(d.filter('form')).data(v,d).bind('submit',_1)}})}return this};fnVB.defaults={loadmsgMode:'none'};fnVB.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
