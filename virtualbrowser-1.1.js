// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(c,w){c.injectBaseHrefToHtml=function(b,e){var f=e.split('#')[0],d=f[o](/([^?]*\/)?(.*)/,'$2'),h=f.split('?')[0][o](/(.*\/)?.*/,'$1');b=b[o](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[o](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[o](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[o](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+h+'$3')[o](/\`<<`>>/g,'');return b};c.getResultBody=c.getResultBody||function(b,e){var f=c.getResultBody;e=e||{};return c('<div/>').append(c(b||[]).not(e.stripFlat||f.stripFlat||'script,title,meta,link,style').find(e.stripDeep||f.stripDeep||'script,style').remove().end())};var E=document.location,z='isDefaultPrevented',F='preventDefault',R='stopPropagation',u='passThrough',n='virtualBrowser',G='VBbeforeload',H='VBload',I='VBerror',J='VBloaded',K='VBdisengaged',o='replace',q='resultDOM',r='result',A='data-srcattr',L=/^(https?:)?\/\//,v=function(b,e,f,d){var h=c.Event(b);h.stopPropagation();e.trigger(h,[f,d]);return h};_2={'load':function(m,t){var a={},g,l,j=c(this),k=j.data(n),i=k.cfg,M;if(c.isPlainObject(m)){c.extend(a,m);l=a.url;delete a.elm}else if(typeof m=='string'){l=m}else{g=c(m);a.elm=g;l=g.attr('href');l=l===w?g.attr('action'):l}l=a.url=(l==='')?E.href:l;if(!k.lastRequest){a.isFirst=true}if(l){if(k._0){a.btn=k._0}var p=v(G,j,a,k);if(!p[u]&&((p[u]===w&&g&&g[0].target&&g[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(l)&&!l.toLowerCase()[o](L,'').indexOf(E.href.toLowerCase()[o](L,'').split('/')[0])==0))){p[u]=true}p[u]&&p[F]();if(!p[z]()){var S=a.noCache=a.noCache!==w?a.noCache:i.noCache,s=i.params?[i.params]:[],x;if(g&&g.is('form')){x=g.attr('method');s.push(g.serialize());var y=k._0;if(y){var B=y.elm;if(B.is(':image')){var N=B[0].name;s.push(N+'.x='+Math.round(y.X));s.push(N+'.y='+Math.round(y.Y))}else{s.push(c.param(B))}delete k._0}var O='multipart/form-data';p._3=g.attr('enctype')==O||g.attr('encoding')==O||!!g.find('input:file')[0]}if(a.params){s.push((typeof a.params=='string')?a.params:c.param(a.params||{}))}s=a.params=s.join('&');x=a.method=a.method||x||'GET';j.addClass(i.loadingClass);if(i.loadmsgElm){M=setTimeout(function(){i.loadmsgMode=='replace'&&j.empty();j.append(i.loadmsgElm)},0)}var P={url:a.url.split('#')[0],data:s,type:x,cache:!S,complete:function(f,d){if(!f){return}clearTimeout(M);j.removeClass(i.loadingClass||'');a.xhr=f;a.status=d||'error';var h=!d||d=='error';if(h){v(I,j,a,k)}else{a[r]=c.injectBaseHrefToHtml(f.responseText||'',a.url);if(i.imgSuppress){a[r]=a[r].replace(/(<img[^>]*? )src=/g,'$1'+A+'=')}}if(a[r]&&i.selector){a[q]=c.getResultBody(a[r],i.stripCfg).find(i.selector)}if(!h||a[r]||a[q]){if(!v(H,j,a,k)[z]()){i.loadmsgElm&&i.loadmsgElm.detach();a[q]=a[q]||c.getResultBody(a[r],i.stripCfg).contents();if(i.imgSuppress){a[q].find('img').add(a[q].filter('img')).attr('src',function(){var b=c(this),e=b.attr(A);b.removeAttr(A);return e})}j.empty().append(a[q]);k.lastRequest=a;v(J,j,a,k);j.find('form').bind('submit.vb'+j.data('VBid'),c.proxy(_1,j[0]));delete a[q];delete a[r]}}delete a.xhr;if(i.disengage){j[n]('disengage')}}};if(p._3){var Q='if'+(new Date).getTime(),C=c('<iframe name="'+Q+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),D=g.attr('action')||'',T=g.attr('target')||'';g.attr('target',Q);if(i.params){g.attr('action',D+(/\?/.test(D)?'&':'?')+i.params)}C.bind('load',function(){var b='success';P.complete({fakeXHR:'iframe',responseText:'<html>'+C.contents().find('html').html()+'</html>'},b);g.attr({target:T,action:D});setTimeout(function(){C.remove()},0)});if(!t||!t._4){g.trigger('submit',['VBiframeHack'])}}else{c.ajax(P)}}return p}},'data':function(){return c(this).data(n)},'disengage':function(){var b=c(this);b.removeData(n).unbind('click submit',_1).find('form').unbind('submit.vb'+b.data('VBid'),_1).end().unbind([G,I,H,J].join(' '));v(K,b);b.unbind(K)}},_1=function(b){if(!b[z]()&&!b[n+'Handled']){var e=c(b.target).closest((b.type=='submit')?'[action]':'input:submit, button:submit, input:image, [href]',this);if(e[0]){var f=c(this);if(e.is('input, button')){if(!e[0].disabled){var d=f.data(n);if(e.is(':image')){var h=e.offset();d._0={elm:e,X:b.pageX-h.left,Y:b.pageY-h.top}}else if(e.is('[name]')){d._0={elm:e}}d._0&&setTimeout(function(){delete d._0},0)}}else{var m=_2['load'].call(f[0],e,{_4:true});if(!m[u]){!m._3&&b[F]();m.isPropagationStopped()&&b[R]();b[n+'Handled']=true}}}}},fnVB=c.fn[n]=function(t,a){var g=this,l=typeof t=='string';if(l){var j=_2[t],k;if(j){g.each(function(b){var e=j.apply(this,[].concat(a));if(!b){k=e}})}if(k!==w){return k}}else{g.each(function(){var f=c(this),d=c.extend({},fnVB.defaults,t);c.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(b,e){b='on'+e;d[b]&&g.bind('VB'+e.toLowerCase(),d[b]);delete d[b]});d.params=(typeof d.params=='string')?d.params:c.param(d.params||{});a&&(d.url=a);if(d.loadmsgMode!='none'){var h=d.loadmsgElm||'<div class="loading" />',m=(fnVB.i18n[f.closest('*[lang]').attr('lang')]||{}).loading||fnVB.i18n.en.loading;if(h.charAt){h=h.replace(/%\{msg\}/g,m)}h=d.loadmsgElm=c(h);if(!h.text()){h.append(m)}}else{delete d.loadmsgElm}f.data(n,{cfg:d});f.bind('click',_1);f.data('VBid',(new Date()).getTime());if(d.url){f[n]('load',d.url)}else{f.find('form').add(f.filter('form')).bind('submit.vb'+f.data('VBid'),c.proxy(_1,f[0]))}})}return this};fnVB.defaults={loadmsgMode:'none'};fnVB.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
