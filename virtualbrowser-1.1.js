// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(b,v){b.injectBaseHrefToHtml=function(c,i){var e=i.split('#')[0],d=e[n](/([^?]*\/)?(.*)/,'$2'),a=e.split('?')[0][n](/(.*\/)?.*/,'$1');c=c[n](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[n](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[n](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[n](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+a+'$3')[n](/\`<<`>>/g,'');return c};b.getResultBody=b.getResultBody||function(c,i){var e=b.getResultBody;i=i||{};return b('<div/>').append(b(c||[]).not(i.stripFlat||e.stripFlat||'script,title,meta,link,style').find(i.stripDeep||e.stripDeep||'script,style').remove().end())};var F=document.location,A='isDefaultPrevented',G='preventDefault',w='stopPropagation',s='passThrough',l='virtualBrowser',H='VBbeforeload',I='VBload',J='VBerror',K='VBloaded',L='VBdisengaged',n='replace',q='resultDOM',r='result',M=/^(https?:)?\/\//,N={'load':function(d){var a={},f,g,j=b(this),m=j.data(l),h=m.cfg,k=b.Event(H),o,B,O;if(b.isPlainObject(d)){b.extend(a,d);g=a.url;delete a.elm}else if(typeof d=='string'){g=d}else{f=b(d);a.elm=f;g=f.attr('href');g=g===v?f.attr('action'):g}g=a.url=(g==='')?F.href:g;if(m.$$empty){a.isFirst=true;delete m.$$empty}if(g){k[w]();j.trigger(k,[a]);if(!k[s]&&((k[s]===v&&f&&f[0].target&&f[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(g)&&!g.toLowerCase()[n](M,'').indexOf(F.href.toLowerCase()[n](M,'').split('/')[0])==0))){k[s]=true}k[s]&&k[G]();if(!k[A]()){var S=a.noCache=a.noCache!==v?a.noCache:h.noCache,p=h.params?[h.params]:[],x;if(f&&f.is('form')){x=f.attr('method');p.push(f.serialize());var y=m._0;if(y){var C=y.elm;if(C.is(':image')){var P=C[0].name;p.push(P+'.x='+Math.round(y.X));p.push(P+'.y='+Math.round(y.Y))}else{p.push(b.param(C))}delete m._0}var Q='multipart/form-data';k._1=f.attr('enctype')==Q||f.attr('encoding')==Q||!!f.find('input:file')[0]}if(a.params){p.push((typeof a.params=='string')?a.params:b.param(a.params||{}))}p=a.params=p.join('&');x=a.method=a.method||x||'GET';j.addClass(h.loadingClass);if(h.loadmsgElm){O=setTimeout(function(){h.loadmsgMode=='replace'&&j.empty();j.append(h.loadmsgElm)},0)}var z={url:a.url.split('#')[0],data:p,type:x,cache:!S,complete:function(c,i){if(!c){return}clearTimeout(O);j.removeClass(h.loadingClass||'');a.xhr=c;a.status=i||'error';var e=!i||i=='error';if(e){j.trigger(J,[a])}else{a[r]=b.injectBaseHrefToHtml(c.responseText||'',a.url)}if(a[r]&&h.selector){a[q]=b.getResultBody(a[r],h.stripCfg).find(h.selector)}if(!e||a[r]||a[q]){o=b.Event(I);o[w]();j.trigger(o,[a]);if(!o[A]()){B=b.Event(K);B[w]();h.loadmsgElm&&h.loadmsgElm.detach();a[q]=a[q]||b.getResultBody(a[r],h.stripCfg).contents();j.empty().append(a[q]);m.lastRequest=a;j.trigger(B,[a]).find('form').data(l,j).bind('submit',t);delete a[q];delete a[r]}}delete a.xhr;if(h.disengage){j[l]('disengage')}}};if(k._1){z=b.extend({},z);var R='if'+(new Date).getTime(),D=b('<iframe name="'+R+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),E=f.attr('action')||'',T=f.attr('target')||'';f.attr('target',R);if(h.params){f.attr('action',E+(/\?/.test(E)?'&':'?')+h.params)}D.bind('load',function(){var c='success';z.complete({fakeXHR:'iframe',responseText:'<html>'+D.contents().find('html').html()+'</html>'},c);f.attr({target:T,action:E});setTimeout(function(){D.remove()},0)})}else{b.ajax(z)}}}return k},'data':function(){return b(this).data(l)},'disengage':function(){var c=b(this);c.removeData(l).unbind('click',t).find('form').removeData(l).unbind('click',t).end().unbind([H,J,I,K].join(' ')).trigger(L).unbind(L)}},t=function(c){var i=(c.type=='submit'),e=i?b(this):b(c.target).closest('[href], input:submit, button:submit, input:image'),d=i?e.data(l):this;if(e[0]){if(!c[A]()){if(e.is('input, button')){if(!e[0].disabled){var a=b(d).data(l);if(e.is(':image')){var f=e.offset();a._0={elm:e,X:c.pageX-f.left,Y:c.pageY-f.top}}else if(e.is('[name]')){a._0={elm:e}}setTimeout(function(){delete a._0},0)}}else{var g=N['load'].call(d,e);if(!g[s]){!g._1&&c[G]();g.isPropagationStopped()&&c[w]()}}}}},u=b.fn[l]=function(g,j){var m=this,h=typeof g=='string';if(h){var k=N[g],o;if(k){m.each(function(c){var i=k.apply(this,[].concat(j));if(!c){o=i}})}if(o!==v){return o}}else{m.each(function(){var e=b(this),d=b.extend({},u.defaults,g);b.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(c,i){c='on'+i;d[c]&&m.bind('VB'+i.toLowerCase(),d[c]);delete d[c]});d.params=(typeof d.params=='string')?d.params:b.param(d.params||{});j&&(d.url=j);if(d.loadmsgMode!='none'){var a=d.loadmsgElm||'<div class="loading" />',f=(u.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(a.charAt){a=a.replace(/%\{msg\}/g,f)}a=d.loadmsgElm=b(a);if(!a.text()){a.append(f)}}else{delete d.loadmsgElm}e.data(l,{cfg:d,$$empty:1});e.bind('click',t);if(d.url){e[l]('load',d.url)}else{e.find('form').data(l,e).bind('submit',t)}})}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
