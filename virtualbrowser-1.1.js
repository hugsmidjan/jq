// encoding: utf-8
// jQuery.fn.virtualBrowser 1.1 - MIT/GPL Licensed - More info: http://github.com/maranomynet/virtualbrowser/
(function(b,v){b.injectBaseHrefToHtml=function(c,h){var e=h.split('#')[0],f=e[n](/([^?]*\/)?(.*)/,'$2'),i=e.split('?')[0][n](/(.*\/)?.*/,'$1');c=c[n](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+f+'$3')[n](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+f.split('?')[0]+'?')[n](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[n](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+i+'$3')[n](/\`<<`>>/g,'');return c};b.getResultBody=b.getResultBody||function(c,h){var e=b.getResultBody;h=h||{};return b('<div/>').append(b(c||[]).not(h.stripFlat||e.stripFlat||'script,title,meta,link,style').find(h.stripDeep||e.stripDeep||'script,style').remove().end())};var G=document.location,B='isDefaultPrevented',H='preventDefault',w='stopPropagation',s='passThrough',o='virtualBrowser',x=o+'Bdy',I='VBbeforeload',J='VBload',K='VBerror',L='VBloaded',M='VBdisengaged',n='replace',q='resultDOM',r='result',N=/^(https?:)?\/\//,O={'load':function(f,i){var a={},d,j,k=b(this),m=k.data(o),g=m.cfg,l=b.Event(I),y,C,P;if(b.isPlainObject(f)){b.extend(a,f);j=a.url;delete a.elm}else if(typeof f=='string'){j=f}else{d=b(f);a.elm=d;j=d.attr('href');j=j===v?d.attr('action'):j}j=a.url=(j==='')?G.href:j;if(m.$$empty){a.isFirst=true;delete m.$$empty}if(j){l[w]();if(m._0){a.btn=m._0}k.trigger(l,[a]);if(!l[s]&&((l[s]===v&&d&&d[0].target&&d[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(j)&&!j.toLowerCase()[n](N,'').indexOf(G.href.toLowerCase()[n](N,'').split('/')[0])==0))){l[s]=true}l[s]&&l[H]();if(!l[B]()){var U=a.noCache=a.noCache!==v?a.noCache:g.noCache,p=g.params?[g.params]:[],z;if(d&&d.is('form')){z=d.attr('method');p.push(d.serialize());var A=m._0;if(A){var D=A.elm;if(D.is(':image')){var Q=D[0].name;p.push(Q+'.x='+Math.round(A.X));p.push(Q+'.y='+Math.round(A.Y))}else{p.push(b.param(D))}delete m._0}var R='multipart/form-data';l._1=d.attr('enctype')==R||d.attr('encoding')==R||!!d.find('input:file')[0]}if(a.params){p.push((typeof a.params=='string')?a.params:b.param(a.params||{}))}p=a.params=p.join('&');z=a.method=a.method||z||'GET';k.addClass(g.loadingClass);if(g.loadmsgElm){P=setTimeout(function(){g.loadmsgMode=='replace'&&k.empty();k.append(g.loadmsgElm)},0)}var S={url:a.url.split('#')[0],data:p,type:z,cache:!U,complete:function(c,h){if(!c){return}clearTimeout(P);k.removeClass(g.loadingClass||'');a.xhr=c;a.status=h||'error';var e=!h||h=='error';if(e){k.trigger(K,[a])}else{a[r]=b.injectBaseHrefToHtml(c.responseText||'',a.url)}if(a[r]&&g.selector){a[q]=b.getResultBody(a[r],g.stripCfg).find(g.selector)}if(!e||a[r]||a[q]){y=b.Event(J);y[w]();k.trigger(y,[a]);if(!y[B]()){C=b.Event(L);C[w]();g.loadmsgElm&&g.loadmsgElm.detach();a[q]=a[q]||b.getResultBody(a[r],g.stripCfg).contents();k.empty().append(a[q]);m.lastRequest=a;k.trigger(C,[a]).find('form').data(x,k).bind('submit',t);delete a[q];delete a[r]}}delete a.xhr;if(g.disengage){k[o]('disengage')}}};if(l._1){var T='if'+(new Date).getTime(),E=b('<iframe name="'+T+'" src=\'javascript:"";\' style="position:absolute;top:-999em;left:-999em;visibility:hidden;" />').appendTo('body'),F=d.attr('action')||'',V=d.attr('target')||'';d.attr('target',T);if(g.params){d.attr('action',F+(/\?/.test(F)?'&':'?')+g.params)}E.bind('load',function(){var c='success';S.complete({fakeXHR:'iframe',responseText:'<html>'+E.contents().find('html').html()+'</html>'},c);d.attr({target:V,action:F});setTimeout(function(){E.remove()},0)});if(!i||!i._2){d.trigger('submit',['VBiframeHack'])}}else{b.ajax(S)}}}return l},'data':function(){return b(this).data(o)},'disengage':function(){var c=b(this);c.removeData(o).unbind('click',t).find('form').removeData(x).unbind('click',t).end().unbind([I,K,J,L].join(' ')).trigger(M).unbind(M)}},t=function(c){var h=(c.type=='submit'),e=h?b(this):b(c.target).closest('[href], input:submit, button:submit, input:image'),f=h?e.data(x):this;if(e[0]){if(!c[B]()){if(e.is('input, button')){if(!e[0].disabled){var i=b(f).data(o);if(e.is(':image')){var a=e.offset();i._0={elm:e,X:c.pageX-a.left,Y:c.pageY-a.top}}else if(e.is('[name]')){i._0={elm:e}}i._0&&setTimeout(function(){delete i._0},0)}}else{var d=O['load'].call(f,e,{_2:true});if(!d[s]){!d._1&&c[H]();d.isPropagationStopped()&&c[w]()}}}}},u=b.fn[o]=function(d,j){var k=this,m=typeof d=='string';if(m){var g=O[d],l;if(g){k.each(function(c){var h=g.apply(this,[].concat(j));if(!c){l=h}})}if(l!==v){return l}}else{k.each(function(){var e=b(this),f=b.extend({},u.defaults,d);b.each(['Beforeload','Error','Load','Loaded','Disengaged'],function(c,h){c='on'+h;f[c]&&e.bind('VB'+h.toLowerCase(),f[c]);delete f[c]});f.params=(typeof f.params=='string')?f.params:b.param(f.params||{});j&&(f.url=j);if(f.loadmsgMode!='none'){var i=f.loadmsgElm||'<div class="loading" />',a=(u.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||u.i18n.en.loading;if(i.charAt){i=i.replace(/%\{msg\}/g,a)}i=f.loadmsgElm=b(i);if(!i.text()){i.append(a)}}else{delete f.loadmsgElm}e.data(o,{cfg:f,$$empty:1});e.bind('click',t);if(f.url){e[o]('load',f.url)}else{e.find('form').add(e.filter('form')).data(x,e).bind('submit',t)}})}return this};u.defaults={loadmsgMode:'none'};u.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
