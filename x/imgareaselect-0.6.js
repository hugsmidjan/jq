jQuery.imgAreaSelect={onKeyPress:null};jQuery.imgAreaSelect.init=function(e,f){var g=jQuery('<div></div>'),$border1=jQuery('<div></div>'),$border2=jQuery('<div></div>'),$outLeft=jQuery('<div></div>'),$outTop=jQuery('<div></div>'),$outRight=jQuery('<div></div>'),$outBottom=jQuery('<div></div>'),left,top,imgOfs,imgWidth,imgHeight,parent,parOfs,parScroll,adjusted,zIndex=0,fixed,$p,startX,startY,moveX,moveY,resizeMargin=10,resize=[],V=0,H=1,keyDown,d,aspectRatio,x1,x2,y1,y2,x,y,selection={x1:0,y1:0,x2:0,y2:0,width:0,height:0};var h=g.add($border1).add($border2);var i=$outLeft.add($outTop).add($outRight).add($outBottom);function viewX(x){return x+imgOfs.left+parScroll.left-parOfs.left}function viewY(y){return y+imgOfs.top+parScroll.top-parOfs.top}function selX(x){return x-imgOfs.left-parScroll.left+parOfs.left}function selY(y){return y-imgOfs.top-parScroll.top+parOfs.top}function evX(a){return a.pageX+parScroll.left-parOfs.left}function evY(a){return a.pageY+parScroll.top-parOfs.top}function adjust(){imgOfs=jQuery(e).offset();imgWidth=jQuery(e).width();imgHeight=jQuery(e).height();if(jQuery(parent).is('body'))parOfs=parScroll={left:0,top:0};else{parOfs=jQuery(parent).offset();parScroll={left:parent.scrollLeft,top:parent.scrollTop}}left=viewX(0);top=viewY(0)}function update(a){h.css({left:viewX(selection.x1)+'px',top:viewY(selection.y1)+'px',width:Math.max(selection.width-f.borderWidth*2,0)+'px',height:Math.max(selection.height-f.borderWidth*2,0)+'px'});$outLeft.css({left:left+'px',top:top+'px',width:selection.x1+'px',height:imgHeight+'px'});$outTop.css({left:left+selection.x1+'px',top:top+'px',width:selection.width+'px',height:selection.y1+'px'});$outRight.css({left:left+selection.x2+'px',top:top+'px',width:imgWidth-selection.x2+'px',height:imgHeight+'px'});$outBottom.css({left:left+selection.x1+'px',top:top+selection.y2+'px',width:selection.width+'px',height:imgHeight-selection.y2+'px'});if(a!==false){if(jQuery.imgAreaSelect.keyPress!=j)jQuery(document).unbind(jQuery.imgAreaSelect.keyPress,jQuery.imgAreaSelect.onKeyPress);if(f.keys)jQuery(document).bind(jQuery.imgAreaSelect.keyPress,jQuery.imgAreaSelect.onKeyPress=j)}}function areaMouseMove(a){if(!adjusted){adjust();adjusted=true;h.one('mouseout',function(){adjusted=false})}x=selX(evX(a))-selection.x1;y=selY(evY(a))-selection.y1;resize=[];if(f.resizable){if(y<=resizeMargin)resize[V]='n';else if(y>=selection.height-resizeMargin)resize[V]='s';if(x<=resizeMargin)resize[H]='w';else if(x>=selection.width-resizeMargin)resize[H]='e'}$border2.css('cursor',resize.length?resize.join('')+'-resize':f.movable?'move':'')}function areaMouseDown(a){if(a.which!=1)return false;adjust();if(f.resizable&&resize.length>0){jQuery('body').css('cursor',resize.join('')+'-resize');x1=viewX(resize[H]=='w'?selection.x2:selection.x1);y1=viewY(resize[V]=='n'?selection.y2:selection.y1);jQuery(document).mousemove(selectingMouseMove);$border2.unbind('mousemove',areaMouseMove);jQuery(document).one('mouseup',function(){resize=[];jQuery('body').css('cursor','');if(f.autoHide)h.add(i).hide();f.onSelectEnd(e,selection);jQuery(document).unbind('mousemove',selectingMouseMove);$border2.mousemove(areaMouseMove)})}else if(f.movable){moveX=selection.x1+left;moveY=selection.y1+top;startX=evX(a);startY=evY(a);jQuery(document).mousemove(movingMouseMove).one('mouseup',function(){f.onSelectEnd(e,selection);jQuery(document).unbind('mousemove',movingMouseMove)})}else jQuery(e).mousedown(a);return false}function aspectRatioXY(){x2=Math.max(left,Math.min(left+imgWidth,x1+Math.abs(y2-y1)*aspectRatio*(x2>=x1?1:-1)));y2=Math.round(Math.max(top,Math.min(top+imgHeight,y1+Math.abs(x2-x1)/aspectRatio*(y2>=y1?1:-1))));x2=Math.round(x2)}function aspectRatioYX(){y2=Math.max(top,Math.min(top+imgHeight,y1+Math.abs(x2-x1)/aspectRatio*(y2>=y1?1:-1)));x2=Math.round(Math.max(left,Math.min(left+imgWidth,x1+Math.abs(y2-y1)*aspectRatio*(x2>=x1?1:-1))));y2=Math.round(y2)}function doResize(a,b){x2=a;y2=b;if(f.minWidth&&Math.abs(x2-x1)<f.minWidth){x2=x1-f.minWidth*(x2<x1?1:-1);if(x2<left)x1=left+f.minWidth;else if(x2>left+imgWidth)x1=left+imgWidth-f.minWidth}if(f.minHeight&&Math.abs(y2-y1)<f.minHeight){y2=y1-f.minHeight*(y2<y1?1:-1);if(y2<top)y1=top+f.minHeight;else if(y2>top+imgHeight)y1=top+imgHeight-f.minHeight}x2=Math.max(left,Math.min(x2,left+imgWidth));y2=Math.max(top,Math.min(y2,top+imgHeight));if(aspectRatio)if(Math.abs(x2-x1)/aspectRatio>Math.abs(y2-y1))aspectRatioYX();else aspectRatioXY();if(f.maxWidth&&Math.abs(x2-x1)>f.maxWidth){x2=x1-f.maxWidth*(x2<x1?1:-1);if(aspectRatio)aspectRatioYX()}if(f.maxHeight&&Math.abs(y2-y1)>f.maxHeight){y2=y1-f.maxHeight*(y2<y1?1:-1);if(aspectRatio)aspectRatioXY()}selection.x1=selX(Math.min(x1,x2));selection.x2=selX(Math.max(x1,x2));selection.y1=selY(Math.min(y1,y2));selection.y2=selY(Math.max(y1,y2));selection.width=Math.abs(x2-x1);selection.height=Math.abs(y2-y1);update();f.onSelectChange(e,selection)}function selectingMouseMove(a){x2=!resize.length||resize[H]||aspectRatio?evX(a):viewX(selection.x2);y2=!resize.length||resize[V]||aspectRatio?evY(a):viewY(selection.y2);doResize(x2,y2);return false}function doMove(a,b){x2=(x1=a)+selection.width;y2=(y1=b)+selection.height;selection.x1=selX(x1);selection.y1=selY(y1);selection.x2=selX(x2);selection.y2=selY(y2);update();f.onSelectChange(e,selection)}function movingMouseMove(a){var b=Math.max(left,Math.min(moveX+evX(a)-startX,left+imgWidth-selection.width));var c=Math.max(top,Math.min(moveY+evY(a)-startY,top+imgHeight-selection.height));doMove(b,c);a.preventDefault();return false}function startSelection(a){adjust();selection.x1=selection.x2=selX(startX=x1=x2=evX(a));selection.y1=selection.y2=selY(startY=y1=y2=evY(a));selection.width=0;selection.height=0;resize=[];update();h.add(i).show();jQuery(document).unbind('mouseup',cancelSelection).mousemove(selectingMouseMove);$border2.unbind('mousemove',areaMouseMove);f.onSelectStart(e,selection);jQuery(document).one('mouseup',function(){if(f.autoHide||(selection.width*selection.height==0))h.add(i).hide();f.onSelectEnd(e,selection);jQuery(document).unbind('mousemove',selectingMouseMove);$border2.mousemove(areaMouseMove)})}function cancelSelection(){jQuery(document).unbind('mousemove',startSelection);h.add(i).hide()}function imgMouseDown(a){if(a.which!=1)return false;jQuery(document).one('mousemove',startSelection).one('mouseup',cancelSelection);return false}function windowResize(){adjust();update(false);x1=viewX(selection.x1);y1=viewY(selection.y1);x2=viewX(selection.x2);y2=viewY(selection.y2)}var j=function(a){var k=f.keys,d=10,t,key=a.keyCode||a.which;if(!isNaN(k.arrows))d=k.arrows;if(!isNaN(k.shift)&&a.shiftKey)d=k.shift;if(!isNaN(k.ctrl)&&a.ctrlKey)d=k.ctrl;if(!isNaN(k.alt)&&(a.altKey||a.originalEvent.altKey))d=k.alt;if(k.arrows=='resize'||(k.shift=='resize'&&a.shiftKey)||(k.ctrl=='resize'&&a.ctrlKey)||(k.alt=='resize'&&(a.altKey||a.originalEvent.altKey))){switch(key){case 37:d=-d;case 39:t=Math.max(x1,x2);x1=Math.min(x1,x2);x2=Math.max(t+d,x1);if(aspectRatio)aspectRatioYX();break;case 38:d=-d;case 40:t=Math.max(y1,y2);y1=Math.min(y1,y2);y2=Math.max(t+d,y1);if(aspectRatio)aspectRatioXY();break;default:return}doResize(x2,y2)}else{x1=Math.min(x1,x2);y1=Math.min(y1,y2);switch(key){case 37:doMove(Math.max(x1-d,left),y1);break;case 38:doMove(x1,Math.max(y1-d,top));break;case 39:doMove(x1+Math.min(d,imgWidth-selX(x2)),y1);break;case 40:doMove(x1,y1+Math.min(d,imgHeight-selY(y2)));break;default:return}}return false};this.setOptions=function(a){f=jQuery.extend(f,a);if(a.x1!=null){selection.x1=a.x1;selection.y1=a.y1;selection.x2=a.x2;selection.y2=a.y2;a.show=true}if(a.keys)f.keys=jQuery.extend({shift:1,ctrl:'resize'},a.keys===true?{}:a.keys);parent=jQuery(f.parent).get(0);adjust();$p=jQuery(e);while($p.length&&!$p.is('body')){if(!isNaN($p.css('z-index'))&&$p.css('z-index')>zIndex)zIndex=$p.css('z-index');if($p.css('position')=='fixed')fixed=true;$p=$p.parent()}x1=viewX(selection.x1);y1=viewY(selection.y1);x2=viewX(selection.x2);y2=viewY(selection.y2);selection.width=x2-x1;selection.height=y2-y1;update();if(a.hide)h.add(i).hide();else if(a.show)h.add(i).show();i.addClass(f.classPrefix+'-outer');g.addClass(f.classPrefix+'-selection');$border1.addClass(f.classPrefix+'-border1');$border2.addClass(f.classPrefix+'-border2');h.css({borderWidth:f.borderWidth+'px'});g.css({backgroundColor:f.selectionColor,opacity:f.selectionOpacity});$border1.css({borderStyle:'solid',borderColor:f.borderColor1});$border2.css({borderStyle:'dashed',borderColor:f.borderColor2});i.css({opacity:f.outerOpacity,backgroundColor:f.outerColor});aspectRatio=f.aspectRatio&&(d=f.aspectRatio.split(/:/))?d[0]/d[1]:null;if(f.disable||f.enable===false){h.unbind('mousemove',areaMouseMove).unbind('mousedown',areaMouseDown);jQuery(e).add(i).unbind('mousedown',imgMouseDown);jQuery(window).unbind('resize',windowResize)}else if(f.enable||f.disable===false){if(f.resizable||f.movable)h.mousemove(areaMouseMove).mousedown(areaMouseDown);if(!f.persistent)jQuery(e).add(i).mousedown(imgMouseDown);jQuery(window).resize(windowResize)}jQuery(f.parent).append(i.add(h));f.enable=f.disable=undefined};if(jQuery.browser.msie)jQuery(e).attr('unselectable','on');jQuery.imgAreaSelect.keyPress=jQuery.browser.msie||jQuery.browser.safari?'keydown':'keypress';var l={borderColor1:'#000',borderColor2:'#fff',borderWidth:1,classPrefix:'imgareaselect',movable:true,resizable:true,selectionColor:'#fff',selectionOpacity:0.2,outerColor:'#000',outerOpacity:0.2,parent:'body',onSelectStart:function(){},onSelectChange:function(){},onSelectEnd:function(){}};f=jQuery.extend(l,f);this.setOptions(f);h.add(i).css({display:'none',position:fixed?'fixed':'absolute',overflow:'hidden',zIndex:zIndex>0?zIndex:'0'});g.css({borderStyle:'solid'})};jQuery.fn.imgAreaSelect=function(a){a=a||{};this.each(function(){if(jQuery(this).data('imgAreaSelect'))jQuery(this).data('imgAreaSelect').setOptions(a);else{if(a.enable===undefined&&a.disable===undefined)a.enable=true;jQuery(this).data('imgAreaSelect',new jQuery.imgAreaSelect.init(this,a))}});return this};
