// encoding: utf-8
(function(b){b.fn.mapPopulizer=function(a){a=b.extend({listCont:'<ul class="itemlist" />',activeClass:'maplist-active',mappoints:[],itemselector:'div.item',markerActiveClass:'marker-active',liActiveClass:'marker-active',x_flip:1000,markerFlipClass:'marker-flip',bubbleFlipClass:'bubble-flip',dotOffset:[0,0]},a);this.addClass(a.activeClass).each(function(){var i=b(this),k=b('<div class="map" />').appendTo(i),d=a.listCont;d=(typeof d=='string'&&d.indexOf('<')!=-1)?b(d,i):b(d);if(!d.parent().length){d.appendTo(this)}b(a.itemselector,i).hide().each(function(){var c=b(this);var h=b.trim(c.find('h3').eq(0).text());var l=c.find('h3 > a, span.more a').eq(0);var j=b('<li><a href="#">'+h+'</a></li>').appendTo(d);var e=b('<a href="#" class="marker"><span /><i><b>'+h+'</b></i></a>');var m=b('<a href="#" title="Loka" class="close">x</a>');var f='';if(l.length){f=l.attr('href').replace(/^.*?\/nr\/(\d+)($|\/.*$)/,'nr_$1')}if(!f||f=='nr_'){for(var n in a.mappoints){if(a.mappoints[n].label==h){f=n;break}}}if(f){var g=a.mappoints[f]||{x:0,y:0};c.find('h3').html('<span>'+h+'</span>');b([e[0],c.find('h3 span')[0],j.find('a')[0],m[0]]).bind('click',function(){if(c.is(':visible')){c.stop().fadeOut(function(){b(this).css('opacity','');j.removeClass(a.liActiveClass)});e.removeClass(a.markerActiveClass)}else{c.stop().fadeIn(function(){b(this).css('opacity','');e.addClass(a.markerActiveClass)});j.addClass(a.liActiveClass)}return false});e.css({left:g.x+a.dotOffset[0],top:g.y+a.dotOffset[1]}).bind('mouseenter mouseleave',function(o){b('i',this).stop()[o.type=='mouseenter'?'fadeIn':'fadeOut'](function(){b(this).css('opacity','')})});if(g.x>=a.x_flip){c.addClass(a.bubbleFlipClass);e.addClass(a.markerFlipClass)}c.css({left:g.x+a.dotOffset[0],top:g.y+a.dotOffset[1]}).hide().append(m);k.append(c);k.prepend(e)}})});return this}})(jQuery);