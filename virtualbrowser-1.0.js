// encoding: utf-8
// $.fn.virtualBrowser 1.0  -- (c) 2009 Hugsmiðjan ehf. 
(function(c,n){c.fn.detach=c.fn.detach||function(){return this.each(function(){var a=this.parentNode;a&&a.nodeType==1&&a.removeChild(this)})};c.injectBaseHrefToHtml=function(a,f){var b=f.split('#')[0],d=b[i](/([^?]*\/)?(.*)/,'$2'),e=b.split('?')[0][i](/(.*\/)?.*/,'$1');a=a[i](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[i](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[i](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[i](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+e+'$3')[i](/\`<<`>>/g,'');return a};var u=document.location,q='isDefaultPrevented',o='stopPropagation',m='passThrough',l='virtualBrowser',v='VBbeforeload',w='VBload',x='VBloaded',i='replace',y=/^(https?:)?\/\//,z={'load':function(b){var d=typeof b!='string'?c(b):n,e=c(this),h=e.data(l),j=h.cfg,k=c.Event(v),p,r,A=j.loadmsgMode,g=h.lastRequest={elm:d};if(d){b=d.attr('href');b=b===n?d.attr('action'):b}b=g.url=b===''?u.href:b;if(b){k[o]();e.trigger(k,g);if(!k[m]&&((k[m]===n&&d&&d[0].target&&d[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(b)&&!b.toLowerCase()[i](y,'').indexOf(u.href.toLowerCase()[i](y,'').split('/')[0])==0))){k[m]=true}k[m]&&k.preventDefault();if(!k[q]()){var s=j.params,B=g.noCache,C;if(d&&d.is('form')){s=d.serialize()+'&'+s;C=d.attr('method')||'GET'}c.ajax({url:g.url.split('#')[0],data:s,type:C,cache:B!==n?B:!j.noCache,complete:function(a,f){g.result=c.injectBaseHrefToHtml(a.responseText,g.url);g.xhr=a;g.status=f;p=c.Event(w);p[o]();e.trigger(p,g);if(!p[q]()){r=c.Event(x);r[o]();j.loadmsgElm.detach();e.empty().append(g.resultDOM||c.getResultBody(g.result)[0].childNodes).trigger(r,{url:g.url,elm:g.elm}).bind('click',E).find('form').data(l+'Elm',e).bind('submit',D)}}});if(A&&A!='none'){j.loadmsgMode=='replace'&&e.empty();e.append(j.loadmsgElm)}}}return k},'data':function(){return c(this).data(l)}},E=function(a){var f=c(a.target).closest('[href]');if(f[0]){a.VBbody=this;D.call(f,a)}},D=function(a){if(!a[q]()){var f=this,b=a.VBbody||c(f).data(l+'Elm')||this;bfloadEv=z['load'].call(b,f);bfloadEv.isPropagationStopped()&&a[o]();!bfloadEv[m]&&a.preventDefault()}},t=c.fn[l]=function(a,f){var b=typeof a=='string';if(b){var d=z[a];d&&this.each(function(){d.apply(this,[].concat(f))})}else{a=c.extend({loadmsgMode:'none'},a||{});f&&(a.url=f);var e=this,h=a.loadmsgElm||'<div class="loading" />',j=(t.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||t.i18n.en.loading;if(h.charAt){h=h.replace(/%\{msg\}/g,j)}h=a.loadmsgElm=c(h);if(!h.text()){h.append(j)}e.data(l,{cfg:a});a.onLoad&&e.bind(w,a.onLoad);a.onLoaded&&e.bind(x,a.onLoaded);a.onBeforeload&&e.bind(v,a.onBeforeload);a.params=typeof a.params=='string'?a.params:c.param(a.params||{});a.url&&e[l]('load',a.url)}return this};t.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
