// encoding: utf-8
// $.fn.virtualBrowser 1.0  -- (c) 2009 Hugsmiðjan ehf. 
(function(c,o){c.fn.detach=c.fn.detach||function(){return this.each(function(){var a=this.parentNode;a&&a.nodeType==1&&a.removeChild(this)})};c.injectBaseHrefToHtml=function(a,f){var i=f.split('#')[0],d=i[h](/([^?]*\/)?(.*)/,'$2'),b=i.split('?')[0][h](/(.*\/)?.*/,'$1');a=a[h](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[h](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[h](/(["'])([a-z]{3,12}:)/gi,'$1`<<`>>$2')[h](/(<[^>]+ (href|src|action)=["'])([^\/`])/gi,'$1'+b+'$3')[h](/\`<<`>>/g,'');return a};var x=document.location,q='isDefaultPrevented',p='stopPropagation',m='passThrough',k='virtualBrowser',r='VBbeforeload',s='VBload',t='VBloaded',h='replace',y=/^(https?:)?\/\//,z={'load':function(d){var b=typeof d!='string'?c(d):o,e=c(this),n=e.data(k),l=n.cfg,j=c.Event(r),u,A,B=l.loadmsgMode,g=n.lastRequest={elm:b};if(b){d=b.attr('href');d=d===o?b.attr('action'):d}d=g.url=d===''?x.href:d;if(d){e.one(r,function(a){a[p]()}).trigger(j,g);if(!j[m]&&((j[m]===o&&b&&b[0].target&&b[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(d)&&!d.toLowerCase()[h](y,'').indexOf(x.href.toLowerCase()[h](y,'').split('/')[0])==0))){j[m]=true}j[m]&&j.preventDefault();if(!j[q]()){var v=l.params,C=g.noCache,D;if(b&&b.is('form')){v=b.serialize()+'&'+v;D=b.attr('method')||'GET'}c.ajax({url:g.url.split('#')[0],data:v,type:D,cache:C!==o?C:!l.noCache,complete:function(f,i){g.result=c.injectBaseHrefToHtml(f.responseText,g.url);g.xhr=f;g.status=i;u=c.Event(s);e.one(s,function(a){a[p]()}).trigger(u,g);if(!u[q]()){A=c.Event(t);l.loadmsgElm.detach();e.empty().append(g.resultDOM||c.getResultBody(g.result)[0].childNodes).one(t,function(a){a[p]()}).trigger(A,{url:g.url,elm:g.elm}).bind('click',F).find('form').data(k+'Elm',e).bind('submit',E)}}});if(B&&B!='none'){l.loadmsgMode=='replace'&&e.empty();e.append(l.loadmsgElm)}}}return j},'data':function(){return c(this).data(k)}},F=function(a){var f=c(a.target).closest('[href]');if(f[0]){a.VBbody=this;E.call(f,a)}},E=function(a){if(!a[q]()){var f=this,i=a.VBbody||c(f).data(k+'Elm')||this;bfloadEv=z['load'].call(i,f);bfloadEv.isPropagationStopped()&&a[p]();!bfloadEv[m]&&a.preventDefault()}},w=c.fn[k]=function(a,f){var i=typeof a=='string';if(i){var d=z[a];d&&this.each(function(){d.apply(this,[].concat(f))})}else{a=c.extend({loadmsgMode:'none'},a||{});f&&(a.url=f);var b=this,e=a.loadmsgElm||'<div class="loading" />',n=(w.i18n[b.closest('*[lang]').attr('lang')]||{}).loading||w.i18n.en.loading;if(e.charAt){e=e.replace(/%\{msg\}/g,n)}e=a.loadmsgElm=c(e);if(!e.text()){e.append(n)}b.data(k,{cfg:a});a.onLoad&&b.bind(s,a.onLoad);a.onLoaded&&b.bind(t,a.onLoaded);a.onBeforeload&&b.bind(r,a.onBeforeload);a.params=typeof a.params=='string'?a.params:c.param(a.params||{});a.url&&b[k]('load',a.url)}return this};w.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
