// encoding: utf-8
// $.fn.virtualBrowser 1.0  -- (c) 2009 Hugsmiðjan ehf. 
(function(b,q){b.fn.detach=b.fn.detach||function(){return this.each(function(){var a=this.parentNode;a&&a.nodeType==1&&a.removeChild(this)})};var y=document.location,u='isDefaultPrevented',r='stopPropagation',p='passThrough',n='virtualBrowser',z='VBbeforeload',A='VBload',B='VBloaded',c='replace',C=/^(https?:)?\/\//,D={'load':function(e){var g=typeof e!='string'?b(e):q,l=b(this),o=l.data(n).cfg,j=b.Event(z),s,v,E=o.loadmsgMode,d={elm:g};if(g){e=g.attr('href');e=e===q?g.attr('action'):e}e=d.url=e===''?y.href:e;if(e){j[r]();l.trigger(j,d);if(!j[p]&&((j[p]===q&&g&&g[0].target&&g[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(e)&&!e.toLowerCase()[c](C,'').indexOf(y.href.toLowerCase()[c](C,'').split('/')[0])==0))){j[p]=true}j[p]&&j.preventDefault();if(!j[u]()){var w=o.params,F=d.noCache,G;if(g&&g.is('form')){w=g.serialize()+'&'+w;G=g.attr('method')||'GET'}b.ajax({url:d.url.split('#')[0],data:w,type:G,cache:F!==q?F:!o.noCache,complete:function(a,h){var m=d.url.split('#')[0],t=m[c](/([^?]*\/)?(.*)/,'$2'),k=m.split('?')[0][c](/(.*\/)?.*/,'$1'),i=/\?/.test(m),f=a.responseText;i&&(f=f[c](/(['"])\?/gi,'$1¨<<`>>'));f=f[c](/(<[^>]+ (href|src|action)=["'])(["'#¨])/gi,'$1'+t+'$3');i&&(f=f[c](/(['"])¨<<`>>/gi,'$1?')[c](/¨<<`>>/gi,'&amp;'));f=f[c](/http:\/\//gi,'^<<`>>')[c](/https:\/\//gi,'`<<`>>')[c](/(<[^>]+ (href|src|action)=["'])([^\/`\^])/gi,'$1'+k+'$3')[c](/\^<<`>>/g,'http://')[c](/\^<<`>>/g,'http://')[c](/`<<`>>/g,'https://');d.result=f;d.xhr=a;d.status=h;s=b.Event(A);s[r]();l.trigger(s,d);if(!s[u]()){v=b.Event(B);v[r]();o.loadmsgElm.detach();l.empty().append(d.resultDOM||b.getResultBody(d.result)[0].childNodes).trigger(v,{url:d.url,elm:d.elm}).bind('click',I).find('form').data(n+'Elm',l).bind('submit',H)}}});if(E&&E!='none'){o.loadmsgMode=='replace'&&l.empty();l.append(o.loadmsgElm)}}}return j}},I=function(a){var h=b(a.target).closest('[href]');if(h[0]){a.VBbody=this;H.call(h,a)}},H=function(a){if(!a[u]()){var h=this,m=a.VBbody||b(h).data(n+'Elm')||this;bfloadEv=D['load'].call(m,h);bfloadEv.isPropagationStopped()&&a[r]();!bfloadEv[p]&&a.preventDefault()}},x=b.fn[n]=function(a,h){var m=typeof a=='string';if(m){var t=D[a];t&&this.each(function(){t.apply(this,[].concat(h))})}else{a=b.extend({loadmsgMode:'none'},a||{});h&&(a.url=h);var k=this,i=a.loadmsgElm||'<div class="loading" />',f=(x.i18n[k.closest('*[lang]').attr('lang')]||{}).loading||x.i18n.en.loading;if(i.charAt){i=i.replace(/%\{msg\}/g,f)}i=a.loadmsgElm=b(i);if(!i.text()){i.append(f)}k.data(n,{cfg:a});a.onLoad&&k.bind(A,a.onLoad);a.onLoaded&&k.bind(B,a.onLoaded);a.onBeforeload&&k.bind(z,a.onBeforeload);a.params=typeof a.params=='string'?a.params:b.param(a.params||{});a.url&&k[n]('load',a.url)}return this};x.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
