// encoding: utf-8
// $.fn.virtualBrowser 1.0  -- (c) 2009 Hugsmiðjan ehf. 
(function(c,m){c.fn.detach=c.fn.detach||function(){return this.each(function(){var a=this.parentNode;a&&a.nodeType==1&&a.removeChild(this)})};c.injectBaseHrefToHtml=function(a,g){var b=g.split('#')[0],d=b[i](/([^?]*\/)?(.*)/,'$2'),e=b.split('?')[0][i](/(.*\/)?.*/,'$1');a=a[i](/(<[^>]+ (href|src|action)=["'])(["'#])/gi,'$1'+d+'$3')[i](/(<[^>]+ (href|src|action)=["'])\?/gi,'$1'+d.split('?')[0]+'?')[i](/http:\/\//gi,'^<<`>>')[i](/https:\/\//gi,'`<<`>>')[i](/(<[^>]+ (href|src|action)=["'])([^\/`\^])/gi,'$1'+e+'$3')[i](/\^<<`>>/g,'http://')[i](/\^<<`>>/g,'http://')[i](/`<<`>>/g,'https://');return a};var t=document.location,p='isDefaultPrevented',n='stopPropagation',l='passThrough',k='virtualBrowser',u='VBbeforeload',v='VBload',w='VBloaded',i='replace',x=/^(https?:)?\/\//,y={'load':function(b){var d=typeof b!='string'?c(b):m,e=c(this),f=e.data(k).cfg,j=c.Event(u),o,q,z=f.loadmsgMode,h={elm:d};if(d){b=d.attr('href');b=b===m?d.attr('action'):b}b=h.url=b===''?t.href:b;if(b){j[n]();e.trigger(j,h);if(!j[l]&&((j[l]===m&&d&&d[0].target&&d[0].target!=window.name)||(/^([a-z]{3,12}:|\/\/)/i.test(b)&&!b.toLowerCase()[i](x,'').indexOf(t.href.toLowerCase()[i](x,'').split('/')[0])==0))){j[l]=true}j[l]&&j.preventDefault();if(!j[p]()){var r=f.params,A=h.noCache,B;if(d&&d.is('form')){r=d.serialize()+'&'+r;B=d.attr('method')||'GET'}c.ajax({url:h.url.split('#')[0],data:r,type:B,cache:A!==m?A:!f.noCache,complete:function(a,g){h.result=c.injectBaseHrefToHtml(a.responseText,h.url);h.xhr=a;h.status=g;o=c.Event(v);o[n]();e.trigger(o,h);if(!o[p]()){q=c.Event(w);q[n]();f.loadmsgElm.detach();e.empty().append(h.resultDOM||c.getResultBody(h.result)[0].childNodes).trigger(q,{url:h.url,elm:h.elm}).bind('click',D).find('form').data(k+'Elm',e).bind('submit',C)}}});if(z&&z!='none'){f.loadmsgMode=='replace'&&e.empty();e.append(f.loadmsgElm)}}}return j}},D=function(a){var g=c(a.target).closest('[href]');if(g[0]){a.VBbody=this;C.call(g,a)}},C=function(a){if(!a[p]()){var g=this,b=a.VBbody||c(g).data(k+'Elm')||this;bfloadEv=y['load'].call(b,g);bfloadEv.isPropagationStopped()&&a[n]();!bfloadEv[l]&&a.preventDefault()}},s=c.fn[k]=function(a,g){var b=typeof a=='string';if(b){var d=y[a];d&&this.each(function(){d.apply(this,[].concat(g))})}else{a=c.extend({loadmsgMode:'none'},a||{});g&&(a.url=g);var e=this,f=a.loadmsgElm||'<div class="loading" />',j=(s.i18n[e.closest('*[lang]').attr('lang')]||{}).loading||s.i18n.en.loading;if(f.charAt){f=f.replace(/%\{msg\}/g,j)}f=a.loadmsgElm=c(f);if(!f.text()){f.append(j)}e.data(k,{cfg:a});a.onLoad&&e.bind(v,a.onLoad);a.onLoaded&&e.bind(w,a.onLoaded);a.onBeforeload&&e.bind(u,a.onBeforeload);a.params=typeof a.params=='string'?a.params:c.param(a.params||{});a.url&&e[k]('load',a.url)}return this};s.i18n={en:{loading:'Loading...'},is:{loading:'Sæki gögn...'}}})(jQuery);
