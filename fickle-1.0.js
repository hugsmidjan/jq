(function(b){var n=function(a,c,e){var f=b.Event(c);e&&b.extend(f,e);a.trigger(f);return!f.isDefaultPrevented()},h=document,g='fickle',o,i,p=function(a){clearTimeout(o)},j=function(){alert('method not implemented yet.')},r={open:function(a,c){var e=a.c;e.opener=(c&&c.opener)||e.opener;if(!a._0&&n(this,g+'open',{cfg:e})){b(h).bind('focusin',a._1);e.closeOnEsc&&b(h).bind('keydown',a._2);a._0=!0;this.fadeIn(e.fadein||0).queue(function(){b(this).setFocus().trigger({type:g+'opened',cfg:e}).dequeue()})}},close:function(a){var c=a.c;if(!this.height()){this.height(1)}if(a._0&&n(this,g+'close',{cfg:c})){b(h).unbind('focusin',a._1).unbind('keydown',a._2);b(c.opener||h.body).setFocus();a._0=!1;this.fadeOut(c.fadeout||0).queue(function(){b(this).trigger({type:g+'closed',cfg:c}).dequeue()})}},isOpen:function(a){return a._0},disable:j,enable:j,destroy:j},s={focusTarget:'<a href="#" class="focustarget">.</a>',closeOnEsc:true,closeDelay:300},k=g+'-'+b.aquireId();b.fn.fickle=function(d,t){if(typeof d=='string'){var l=r[d];if(l){return(d=='isOpen')?l(this.data(k)):this.each(function(){var a=b(this);l.call(a,a.data(k),t)})}}else{d=b.beget(s,d);var q=this;b.each(['Open','Opened','Close','Closed'],function(a,c){d['on'+c]&&q.bind(g+c.toLowerCase(),d['on'+c])})q.each(function(){var f=b(this),u={c:b.beget(d),_2:function(a){return(a.which!=27)||f.fickle('close')&&false},_1:function(a){var c=f[0];i=a.target!=c&&b(a.target).parents().index(c)==-1}},m;f.data(k,u).toggle(!!d.startOpen).prepend(d.focusTarget).bind('focusout',function(a){var c=this;p();i=false;o=setTimeout(function(){d.trapFocus?b.setFocus(m):i&&b(c).fickle('close')},d.trapFocus?d.closeDelay:0)}).bind('click mousedown focusin',function(c){setTimeout(p,0);if(c.type=='click'){var e=b(this);e.one('mouseleave',function(a){b.setFocus(m)})}else if(c.type=='focusin'){m=c.target}});if(document.body==f.closest('body')[0]){var v=b('a,input,select,textarea,button,object,area').filter(':last').parents().andSelf();if(v.index(this)>-1){b('body').append('<a href="#" style="position:fixed;_3:absolute;left:-9999px;overflow:hidden;width:1px;height:1px;">.</a>')}}if(d.startOpen){f.fickle('open')}})}return this}})(jQuery);
