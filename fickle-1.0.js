// encoding: utf-8
// $.fn.fickle 1.0  -- (c) 2009 Hugsmi√∞jan ehf. 
(function(c,n){var g=function(b,a,f){var d=c.Event(i+a);d.cfg=f;d.stopPropagation();b.trigger(d);return!d.isDefaultPrevented()},h=document,i='fickle',o,j,p=function(b){clearTimeout(o)},q={open:function(a,f){var d=a.c;d.opener=(f&&f.opener)||d.opener;if(!a._0&&g(this,'open',d)){a._1=n;d.fickle&&c(h).bind('focusin',a._2);d.closeOnEsc&&c(h).bind('keydown',a._3);a._0=!0;d.fadein&&this.fadeIn(d.fadein);this.queue(function(){var b=c(this);b.show();g(b,'opened',d);a._1||b.setFocus();b.dequeue()})}},close:function(a){var f=a.c;if(!this.height()){this.height(1)}if(a._0&&g(this,'close',f)){c(h).unbind('focusin',a._2).unbind('keydown',a._3);c.setFocus(f.opener||h.body);a._0=!1;f.fadeout&&this.fadeOut(f.fadeout);this.queue(function(){var b=c(this);b.hide();g(b,'closed',f);b.dequeue()})}},toggle:function(b,a){var f=typeof a=='boolean'?a:a&&a.doOpen!==n?a.doOpen:!b._0;q[f?'open':'close'].call(this,b,a)},isOpen:function(b){return!!b._0}},t={fickle:!0,focusTarget:'<a href="#" class="focustarget">.</a>',closeOnEsc:!0,closeDelay:300},k=i+'-'+c.aquireId();c.fn.fickle=function(e,u){if(typeof e=='string'){var l=q[e];if(l){return(e=='isOpen')?l(this.data(k)):this.each(function(b,a){a=c(a);l.call(a,a.data(k),u)})}}else{e=c.beget(t,e);var r=this;c.each(['Open','Opened','Close','Closed'],function(b,a){e['on'+a]&&r.bind(i+a.toLowerCase(),e['on'+a])});r.each(function(){var d=c(this),s={c:c.beget(e),_3:function(b){return(b.which!=27)||d.fickle('close')&&false},_2:function(b){var a=d[0];j=b.target!=a&&c(b.target).parents().index(a)==-1}},m;d.data(k,s).toggle(!!e.startOpen).prepend(e.focusTarget).bind('focusin focusout',function(b){s._1=b.type=='focusin'});if(e.fickle){d.bind('focusout',function(b){var a=this;p();j=false;o=setTimeout(function(){e.trapFocus?c.setFocus(m):j&&c(a).fickle('close')},e.trapFocus?0:e.closeDelay)}).bind('click mousedown focusin',function(a){setTimeout(p,0);if(a.type=='click'){var f=c(this);f.one('mouseleave',function(b){c.setFocus(m)})}else if(a.type=='focusin'){m=a.target}});if(document.body==d.closest('body')[0]){var v=c('a,input,select,textarea,button,object,area').filter(':last').parents().andSelf();if(v.index(this)>-1){c('body').append('<a href="#" style="position:fixed;_4:absolute;left:-9999px;overflow:hidden;width:1px;height:1px;">.</a>')}}}if(e.startOpen){d.fickle('open')}})}return this}})(jQuery);
