/* jQuery.fn.dumbTags v 1.0  -- (c) 2013 Hugsmiðjan ehf.  @preserve */
!function(v){var b="dumbtags_cfg",a={disable:function(e){this.parent().addClass(e.disabledClass).find("input").prop("disabled",!0)},enable:function(e){this.parent().removeClass(e.disabledClass).find("input").prop("disabled",!1)}},T=v.fn.dumbTags=function(h){return a[h]?this.each(function(){var e=v(this);(e=e.is("input")?e:e.find("input:text")).each(function(){var e=v(this),t=e.data(b);t&&a[h].call(e,t)})}):this.each(function(){var e,r=v(this),o=v.extend(!0,{},T.defaults,h),t=r.closest("[lang]").attr("lang").substr(.2),n=v.extend({},o.i18n[t]||o.i18n.en),s=r.attr("name"),u=o.ajax&&("acUrl"in o&&o.acUrl||r.closest("["+o.acUrlAttr+"]",this.form.parentNode).attr(o.acUrlAttr)||v(this.form).attr("action")||""),c=o.ajax&&encodeURIComponent(r.attr(o.acNameAttr)||o.acName||s),d=[],a=[],p=[],l=function(e){var l=[];return v.each(e,function(e,t){var a={value:t.id||t.value,tag:t.value},i=v(o.tagTempl);a.value&&(i[o.htmlTags?"html":"text"](a.tag).data("dumbTag",a).each(function(){o.processTag&&o.processTag(i,t)}).append(v('<input type="hidden"/>').attr({name:s,value:a.value})).append(v(o.tagDelTempl).attr("title",n.delTitle||n.delLabel).html(n.delLabel)),p.push(a.tag.toLowerCase()),l.push(i[0],document.createTextNode(" ")))}),v(l).insertBefore(r)},f=function(e,t){if(!r[0].disabled){e=v(e);var a=v.Event("dumbTagRemove");if(a.autoDelete=t,e.trigger(a),t||!a.isDefaultPrevented()){var i=v.inArray(e.data("dumbTag").tag.toLowerCase(),p);return-1<i&&p.splice(i,1),e.remove(),!t&&r.trigger("focus"),!0}}return!1},i=function(e){if(e.value||e.id){var t=e.value.toLowerCase(),a=r.prevAll(o.tagSel).filter(function(){var e=v(this).data("dumbTag").tag.toLowerCase()===t;return e&&f(this,!0),!e});o.maxTags&&a.length>=o.maxTags&&f(r.prev(o.tagSel),!0);var i=l([e]);r.val(""),i.trigger("dumbTagAdded")}},m=function(){var e=r.val();o.limitVocab||!e||r.autocomplete("widget").find("a.ui-state-hover,a.ui-state-focus")[0]||(e=v.trim(e.replace(/\s+/g," ")),i({value:e})),setTimeout(function(){r.autocomplete("close")},0)};r.is("select")?(r=(e=r).siblings("input:text"))[0]||("limitVocab"in o||(o.limitVocab=!0),r=v('<input type="text" />').insertAfter(e)):e=r.siblings("select"),e.detach().find("option").each(function(){var e=v(this),t={id:e.val(),value:e.text()};t.id&&(t.label=t.value,d.push(t),e.is("[selected]")&&a.push({id:e.val(),value:e.text()}))});var g=r.attr("value");g&&(o.splitter&&v.each(g.split(o.splitter),function(e,t){(t=v.trim(t).replace(/\s+/g,""))&&a.push({id:t,value:t})}),r.val()===g&&r.val("")),r.wrap(o.wrapperTempl).parent().bind("click",function(e){if(e.target===this)r.trigger("focus");else if(v(e.target).is(o.delSel))return f(v(e.target).closest(o.tagSel)),!1}),r.data(b,o).attr("name","").attr("autocomplete","off").bind("focus",function(){clearTimeout(o.blurTimeout),v(this.parentNode).addClass(o.focusClass)}).one("focus",function(){if(r.bind("keydown",function(e){if(!this.value&&8===e.which){var a=v(this);setTimeout(function(){var e=a.prev(o.tagSel),t=e.data("dumbTag").tag;f(e)&&a.val(o.htmlTags?t.replace(/<.+?>/g,""):t)[0].select()},0)}13===e.which&&(e.preventDefault(),m())}).bind("blur",function(){o.blurTimeout=setTimeout(function(){m(),r.val("").parent().removeClass(o.focusClass)},350)}),o.splitter&&r.bind("keypress",function(e){o.splitter.test(String.fromCharCode(e.which))&&(e.preventDefault(),m())}),o.ajax||d[0]){var e=d[0]?{minLength:0}:{};r.autocomplete(v.extend({position:{of:r.parent()}},o.acCfg,e,{source:function(e,a){var t=v.trim(e.term.toLowerCase()).replace(/\s+/g," ");if(o.ajax&&e.term.length>=o.acCfg.minLength)o.ajaxMethod?o.ajaxMethod({term:t,input:r,config:o,callback:a}):v.ajax({url:u,type:o.ajaxCfg.type,data:c+"="+encodeURIComponent(t),dataType:o.ajaxCfg.dataType,success:function(e){if(o.acFixResults){var t=o.acFixResults(e);e=void 0===t?e:t}e=v.map(e,function(e){return o.acFixItem?o.acFixItem(e):(e.id=e.value,e.value=e.tag),delete e.tag,-1===v.inArray(e.value.toLowerCase(),p)?e:null}),a(e)}});else{for(var i,l=[],n=0;i=d[n++];){var s=i.label.toLowerCase();-1<s.indexOf(t)&&-1===v.inArray(s,p)&&l.push(i)}a(l)}}})).one("autocompleteopen",function(){r.autocomplete("widget").attr("class",o.acMenuClass)}).bind("autocompleteopen",function(){r.autocomplete("widget").width(r.parent().outerWidth())}).bind("autocompletefocus",function(){return!1}).bind("autocompleteselect",function(e,t){return i(t.item),o.reShowLocals&&setTimeout(function(){r.autocomplete("search")},100),r.blur(),!1}),o.acCfg.minLength&&!o.showLocals||r.bind("focus",function(){r.autocomplete("search")}).autocomplete("search")}}),l(a),a=e=void 0}),this};T.defaults={i18n:{en:{delTitle:"Remove this value",delLabel:"x"},is:{delTitle:"Eyða þessu gildi",delLabel:"x"}},wrapperTempl:'<span class="tagswrap"/>',disabledClass:"disabled",tagTempl:'<span class="tag"/>',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:"focused",tagSel:".tag",delSel:"a.del",splitter:/,|;/,ajax:!0,showLocals:!0,acUrlAttr:"data-suggesturl",acNameAttr:"data-acname",acMenuClass:"tags-acmenu ui-autocomplete ui-menu",acCfg:{minLength:2,delay:300,html:!0},ajaxCfg:{dataType:"json"}}}(jQuery);
