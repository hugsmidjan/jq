// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(d){var q=d.fn.dumbTags=function(v){this.each(function(z){var e=d(this),a=d.extend(true,{},q.defaults,v),w=e.closest('[lang]').attr('lang').substr(0.2),n=d.extend({},a.i18n[w]||a.i18n.en),r=e.attr('name'),x=a.ajax&&(('acUrl'in a&&a.acUrl)||e.closest('['+a.acUrlAttr+']',this.form.parentNode).attr(a.acUrlAttr)||d(this.form).attr('action')||''),y=a.ajax&&encodeURIComponent(e.attr(a.acNameAttr)||a.acName||r),j=[],l=[],s=function(f){var g=[];d.each(f,function(c,b){g.push(d(a.tagTempl).text(b.value).data('dumbTag',{value:b.id||b.value,tag:b.value}).append(d('<input type="hidden"/>').attr({name:r,value:b.id||b.value})).append(d(a.tagDelTempl).attr('title',n.delTitle||n.delLabel).html(n.delLabel)).attr('title',b.value)[0])});return d(g).insertBefore(e)},t=function(b){var f=b.value.toLowerCase(),g=e.prevAll(a.tagSel).filter(function(){var c=this.title.toLowerCase()!=f;c||m(this,true);return c});if(a.maxTags&&g.length>=a.maxTags){m(e.prev(a.tagSel),true)}var h=s([b]);e.val('');h.trigger('dumbTagAdded')},m=function(c,b){c=d(c);var f=d.Event('dumbTagRemove');f.autoDelete=b;c.trigger(f);if(b||!f.isDefaultPrevented()){c.remove();return true}return false},k;a.splitter=a.splitter||',';if(e.is('select')){if(!('limitVocab'in a)){a.limitVocab=true}k=e;e=d('<input type="text" />').insertAfter(k)}else{k=e.siblings('select')}k.detach().find('option').each(function(){var c=d(this);if(!a.ajax){item={id:c.val(),value:c.text()};item.label=item.value;j.push(item)}if(c.is('[selected]')){l.push({id:c.val(),value:c.text()})}});var o=e.attr('value');if(o){d.each(o.split(a.splitter),function(c,b){b=d.trim(b).replace(/\s+/g,'');if(b){l.push({id:b,value:b})}});if(e.val()==o){e.val('')}}e.attr('name','').wrap(a.wrapperTempl).parent().bind('click',function(c){if(c.target==this){e.trigger('focus')}else if(d(c.target).is(a.delSel)){m(d(c.target).closest(a.tagSel));return false}}).end().attr('autocomplete','off').bind('focus',function(c){d(this).parent().addClass(a.focusClass)}).one('focus',function(A){e.bind('keypress',function(f){if(!this.value&&f.which==8){var g=d(this);setTimeout(function(){var c=g.prev(a.tagSel),b=c.attr('title');if(m(c)){g.val(b)[0].select()}},0)}else if(f.which==13||f.which==44){if(!a.limitVocab&&this.value){var h=d.trim(this.value.replace(/\s+/g,' '));t({value:h})}d(this).autocomplete('close');return false}}).bind('blur',function(c){d(this).val('').parent().removeClass(a.focusClass)});if(a.ajax||j.length){e.autocomplete(d.extend({position:{of:e.parent()}},a.acCfg,{minLength:a.ajax?a.acCfg.minLength:0,source:function(g,h){var p=d.trim(g.term.toLowerCase()).replace(/\s+/g,' ');if(a.ajax){if(a.ajaxMethod){a.ajaxMethod({term:p,input:e,config:a,callback:h})}else{d.ajax({url:x,type:a.ajaxCfg.type,data:y+"="+encodeURIComponent(p),dataType:a.ajaxCfg.dataType,success:function(f){if(a.acFixResults){f=a.acFixResults(f)}d.each(f,function(c,b){if(a.acFixItem){a.acFixItem(b)}else{b.id=b.value;b.value=b.tag}delete b.tag});h(f)}})}}else{var u=[];i=0;while(j[i]){if(j[i].label.toLowerCase().indexOf(p)>-1){u.push(j[i])}i++}h(u)}}})).one('autocompleteopen',function(c,b){e.autocomplete('widget').attr('class',a.acMenuClass)}).bind('autocompleteopen',function(c,b){e.autocomplete('widget').width(e.parent().outerWidth())}).bind('autocompletefocus',function(c,b){return false}).bind('autocompleteselect',function(c,b){t(b.item);return false});if(!a.ajax){e.bind('focus',function(c){e.autocomplete('search')}).autocomplete('search')}}});s(l);l=k=undefined});return this};q.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:1,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
