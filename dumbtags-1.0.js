// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(c){var s=c.fn.dumbTags=function(y){this.each(function(D){var d=c(this),a=c.extend(true,{},s.defaults,y),z=d.closest('[lang]').attr('lang').substr(0.2),n=c.extend({},a.i18n[z]||a.i18n.en),t=d.attr('name'),A=a.ajax&&(('acUrl'in a&&a.acUrl)||d.closest('['+a.acUrlAttr+']',this.form.parentNode).attr(a.acUrlAttr)||c(this.form).attr('action')||''),B=a.ajax&&encodeURIComponent(d.attr(a.acNameAttr)||a.acName||t),o=[],l=[],i=[],u=function(j){var h=[];c.each(j,function(b,e){var f={value:e.id||e.value,tag:e.value},g=c(a.tagTempl);g[a.htmlTags?'html':'text'](f.tag).data('dumbTag',f).each(function(){a.processTag&&a.processTag(g,e)}).append(c('<input type="hidden"/>').attr({name:t,value:f.value})).append(c(a.tagDelTempl).attr('title',n.delTitle||n.delLabel).html(n.delLabel));i.push(f.tag.toLowerCase());h.push(g[0])});return c(h).insertBefore(d)},v=function(e){var f=e.value.toLowerCase(),g=d.prevAll(a.tagSel).filter(function(){var b=c(this).data('dumbTag').tag.toLowerCase()==f;if(b){m(this,true)}return!b});if(a.maxTags&&g.length>=a.maxTags){m(d.prev(a.tagSel),true)}var j=u([e]);d.val('');j.trigger('dumbTagAdded')},m=function(b,e){b=c(b);var f=c.Event('dumbTagRemove');f.autoDelete=e;b.trigger(f);if(e||!f.isDefaultPrevented()){var g=c.inArray(b.data('dumbTag').tag.toLowerCase(),i);if(g>-1){i.splice(g,1)}b.remove();return true}return false},k;a.splitter=a.splitter||',';if(d.is('select')){if(!('limitVocab'in a)){a.limitVocab=true}k=d;d=c('<input type="text" />').insertAfter(k)}else{k=d.siblings('select')}k.detach().find('option').each(function(){var b=c(this);if(!a.ajax){itm={id:b.val(),value:b.text()};itm.label=itm.value;o.push(itm)}if(b.is('[selected]')){l.push({id:b.val(),value:b.text()})}});var p=d.attr('value');if(p){c.each(p.split(a.splitter),function(b,e){e=c.trim(e).replace(/\s+/g,'');if(e){l.push({id:e,value:e})}});if(d.val()==p){d.val('')}}d.attr('name','').wrap(a.wrapperTempl).parent().bind('click',function(b){if(b.target==this){d.trigger('focus')}else if(c(b.target).is(a.delSel)){m(c(b.target).closest(a.tagSel));return false}}).end().attr('autocomplete','off').bind('focus',function(b){c(this).parent().addClass(a.focusClass)}).one('focus',function(E){d.bind('keydown',function(f){if(!this.value&&f.which==8){var g=c(this);setTimeout(function(){var b=g.prev(a.tagSel),e=b.data('dumbTag').tag;if(m(b)){g.val(e)[0].select()}},0)}}).bind('keypress',function(b){if(b.which==13||b.which==44){if(!a.limitVocab&&this.value){var e=c.trim(this.value.replace(/\s+/g,' '));v({value:e})}c(this).autocomplete('close');return false}}).bind('blur',function(b){c(this).val('').parent().removeClass(a.focusClass)});if(a.ajax||o.length){if(!a.ajax){a.acCfg.minLength=0}d.autocomplete(c.extend({position:{of:d.parent()}},a.acCfg,{source:function(j,h){var q=c.trim(j.term.toLowerCase()).replace(/\s+/g,' ');if(a.ajax){if(a.ajaxMethod){a.ajaxMethod({term:q,input:d,config:a,callback:h})}else{c.ajax({url:A,type:a.ajaxCfg.type,data:B+"="+encodeURIComponent(q),dataType:a.ajaxCfg.dataType,success:function(f){if(a.acFixResults){var g=a.acFixResults(f);f=g===undefined?f:g}f=c.map(f,function(b,e){if(a.acFixItem){a.acFixItem(b)}else{b.id=b.value;b.value=b.tag}delete b.tag;return(c.inArray(b.value.toLowerCase(),i)==-1)?b:null});h(f)}})}}else{var w=[],C=0,r;while((r=o[C++])){var x=r.label.toLowerCase();if(x.indexOf(q)>-1){if(c.inArray(x,i)==-1){w.push(r)}}}h(w)}}})).one('autocompleteopen',function(b,e){d.autocomplete('widget').attr('class',a.acMenuClass)}).bind('autocompleteopen',function(b,e){d.autocomplete('widget').width(d.parent().outerWidth())}).bind('autocompletefocus',function(b,e){return false}).bind('autocompleteselect',function(b,e){v(e.item);if(!a.acCfg.minLength){setTimeout(function(){d.autocomplete('search')},100)}return false});if(!a.acCfg.minLength){d.bind('focus',function(b){d.autocomplete('search')}).autocomplete('search')}}});u(l);l=k=undefined});return this};s.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:true,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
