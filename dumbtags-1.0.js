// $.fn.dumbTags 1.0  -- (c) 2012-2013 Hugsmiðjan ehf.
(function(e){var t="dumbtags_cfg",a={disable:function(e){this.parent().addClass(e.disabledClass).find("input").prop("disabled",true)},enable:function(e){this.parent().removeClass(e.disabledClass).find("input").prop("disabled",false)}};var i=e.fn.dumbTags=function(l){if(a[l]){this.each(function(){var i=e(this);i=i.is("input")?i:i.find("input:text");i.each(function(){var i=e(this),n=i.data(t);n&&a[l].call(i,n)})})}else{this.each(function(){var a=e(this),n=e.extend(true,{},i.defaults,l),s=a.closest("[lang]").attr("lang").substr(.2),r=e.extend({},n.i18n[s]||n.i18n.en),u=a.attr("name"),o=n.ajax&&("acUrl"in n&&n.acUrl||a.closest("["+n.acUrlAttr+"]",this.form.parentNode).attr(n.acUrlAttr)||e(this.form).attr("action")||""),c=n.ajax&&encodeURIComponent(a.attr(n.acNameAttr)||n.acName||u),f=[],d=[],p=[],m=function(t){var i=[];e.each(t,function(t,a){var l={value:a.id||a.value,tag:a.value},s=e(n.tagTempl);if(l.value){s[n.htmlTags?"html":"text"](l.tag).data("dumbTag",l).each(function(){n.processTag&&n.processTag(s,a)}).append(e('<input type="hidden"/>').attr({name:u,value:l.value})).append(e(n.tagDelTempl).attr("title",r.delTitle||r.delLabel).html(r.delLabel));p.push(l.tag.toLowerCase());i.push(s[0],document.createTextNode(" "))}});return e(i).insertBefore(a)},g=function(t,i){if(!a[0].disabled){t=e(t);var l=e.Event("dumbTagRemove");l.autoDelete=i;t.trigger(l);if(i||!l.isDefaultPrevented()){var n=e.inArray(t.data("dumbTag").tag.toLowerCase(),p);if(n>-1){p.splice(n,1)}t.remove();!i&&a.trigger("focus");return true}}return false},h=function(t){if(t.value||t.id){var i=t.value.toLowerCase(),l=a.prevAll(n.tagSel).filter(function(){var t=e(this).data("dumbTag").tag.toLowerCase()===i;if(t){g(this,true)}return!t});if(n.maxTags&&l.length>=n.maxTags){g(a.prev(n.tagSel),true)}var s=m([t]);a.val("");s.trigger("dumbTagAdded")}},v=function(){var t=a.val();if(!n.limitVocab&&t&&!a.autocomplete("widget").find("a.ui-state-hover,a.ui-state-focus")[0]){t=e.trim(t.replace(/\s+/g," "));h({value:t})}setTimeout(function(){a.autocomplete("close")},0)},b;if(a.is("select")){b=a;a=b.siblings("input:text");if(!a[0]){if(!("limitVocab"in n)){n.limitVocab=true}a=e('<input type="text" />').insertAfter(b)}}else{b=a.siblings("select")}b.detach().find("option").each(function(){var t=e(this),a={id:t.val(),value:t.text()};a.label=a.value;f.push(a);if(t.is("[selected]")){d.push({id:t.val(),value:t.text()})}});var T=a.attr("value");if(T){if(n.splitter){e.each(T.split(n.splitter),function(t,a){a=e.trim(a).replace(/\s+/g,"");if(a){d.push({id:a,value:a})}})}if(a.val()===T){a.val("")}}a.wrap(n.wrapperTempl).parent().bind("click",function(t){if(t.target===this){a.trigger("focus")}else if(e(t.target).is(n.delSel)){g(e(t.target).closest(n.tagSel));return false}});a.data(t,n).attr("name","").attr("autocomplete","off").bind("focus",function(){clearTimeout(n.blurTimeout);e(this.parentNode).addClass(n.focusClass)}).one("focus",function(){a.bind("keydown",function(t){if(!this.value&&t.which===8){var a=e(this);setTimeout(function(){var e=a.prev(n.tagSel),t=e.data("dumbTag").tag;if(g(e)){a.val(n.htmlTags?t.replace(/<.+?>/g,""):t)[0].select()}},0)}if(t.which===13){t.preventDefault();v()}}).bind("blur",function(){n.blurTimeout=setTimeout(function(){v();a.val("").parent().removeClass(n.focusClass)},150)});if(n.splitter){a.bind("keypress",function(e){if(n.splitter.test(String.fromCharCode(e.which))){e.preventDefault();v()}})}if(n.ajax||f[0]){var t=f[0]?{minLength:0}:{};a.autocomplete(e.extend({position:{of:a.parent()}},n.acCfg,t,{source:function(t,i){var l=e.trim(t.term.toLowerCase()).replace(/\s+/g," ");if(n.ajax&&t.term.length>=n.acCfg.minLength){if(n.ajaxMethod){n.ajaxMethod({term:l,input:a,config:n,callback:i})}else{e.ajax({url:o,type:n.ajaxCfg.type,data:c+"="+encodeURIComponent(l),dataType:n.ajaxCfg.dataType,success:function(t){if(n.acFixResults){var a=n.acFixResults(t);t=a===undefined?t:a}t=e.map(t,function(t){if(n.acFixItem){n.acFixItem(t)}else{t.id=t.value;t.value=t.tag}delete t.tag;return e.inArray(t.value.toLowerCase(),p)===-1?t:null});i(t)}})}}else{var s=[],r=0,u;while(u=f[r++]){var d=u.label.toLowerCase();if(d.indexOf(l)>-1){if(e.inArray(d,p)===-1){s.push(u)}}}i(s)}}})).one("autocompleteopen",function(){a.autocomplete("widget").attr("class",n.acMenuClass)}).bind("autocompleteopen",function(){a.autocomplete("widget").width(a.parent().outerWidth())}).bind("autocompletefocus",function(){return false}).bind("autocompleteselect",function(e,t){h(t.item);if(n.reShowLocals){setTimeout(function(){a.autocomplete("search")},100)}return false});if(!n.acCfg.minLength||n.showLocals){a.bind("focus",function(){a.autocomplete("search")}).autocomplete("search")}}});m(d);d=b=undefined})}return this};i.defaults={i18n:{en:{delTitle:"Remove this value",delLabel:"x"},is:{delTitle:"Eyða þessu gildi",delLabel:"x"}},wrapperTempl:'<span class="tagswrap"/>',disabledClass:"disabled",tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:"focused",tagSel:".tag",delSel:"a.del",splitter:/,|;/,ajax:true,showLocals:true,acUrlAttr:"data-suggesturl",acNameAttr:"data-acname",acMenuClass:"tags-acmenu ui-autocomplete ui-menu",acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:"json"}}})(jQuery);
