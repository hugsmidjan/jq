// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(d){var t=d.fn.dumbTags=function(z){this.each(function(E){var e=d(this),b=d.extend(true,{},t.defaults,z),A=e.closest('[lang]').attr('lang').substr(0.2),o=d.extend({},b.i18n[A]||b.i18n.en),u=e.attr('name'),B=b.ajax&&(('acUrl'in b&&b.acUrl)||e.closest('['+b.acUrlAttr+']',this.form.parentNode).attr(b.acUrlAttr)||d(this.form).attr('action')||''),C=b.ajax&&encodeURIComponent(e.attr(b.acNameAttr)||b.acName||u),p=[],m=[],l=[],v=function(j){var i=[];d.each(j,function(c,f){var g={value:f.id||f.value,tag:f.value},h=d(b.tagTempl);h[b.htmlTags?'html':'text'](g.tag).data('dumbTag',g).each(function(){b.processTag&&b.processTag(h,f)}).append(d('<input type="hidden"/>').attr({name:u,value:g.value})).append(d(b.tagDelTempl).attr('title',o.delTitle||o.delLabel).html(o.delLabel));l.push(g.tag.toLowerCase());i.push(h[0])});return d(i).insertBefore(e)},w=function(f){var g=f.value.toLowerCase(),h=e.prevAll(b.tagSel).filter(function(){var c=d(this).data('dumbTag').tag.toLowerCase()==g;if(c){n(this,true)}return!c});if(b.maxTags&&h.length>=b.maxTags){n(e.prev(b.tagSel),true)}var j=v([f]);e.val('');j.trigger('dumbTagAdded')},n=function(c,f){c=d(c);var g=d.Event('dumbTagRemove');g.autoDelete=f;c.trigger(g);if(f||!g.isDefaultPrevented()){var h=d.inArray(c.data('dumbTag').tag.toLowerCase(),l);if(h>-1){l.splice(h,1)}c.remove();e.trigger('focus');return true}return false},k;b.splitter=b.splitter||',';if(e.is('select')){k=e;e=k.siblings('input:text');if(!e[0]){if(!('limitVocab'in b)){b.limitVocab=true}e=d('<input type="text" />').insertAfter(k)}}else{k=e.siblings('select')}k.detach().find('option').each(function(){var c=d(this);if(!b.ajax){itm={id:c.val(),value:c.text()};itm.label=itm.value;p.push(itm)}if(c.is('[selected]')){m.push({id:c.val(),value:c.text()})}});var q=e.attr('value');if(q){d.each(q.split(b.splitter),function(c,f){f=d.trim(f).replace(/\s+/g,'');if(f){m.push({id:f,value:f})}});if(e.val()==q){e.val('')}}e.attr('name','').wrap(b.wrapperTempl).parent().bind('click',function(c){if(c.target==this){e.trigger('focus')}else if(d(c.target).is(b.delSel)){n(d(c.target).closest(b.tagSel));return false}}).end().attr('autocomplete','off').bind('focus',function(c){d(this).parent().addClass(b.focusClass)}).one('focus',function(F){e.bind('keydown',function(g){if(!this.value&&g.which==8){var h=d(this);setTimeout(function(){var c=h.prev(b.tagSel),f=c.data('dumbTag').tag;if(n(c)){h.val(f)[0].select(a)}},0)}if(g.which==13){if(!b.limitVocab&&this.value&&!d(this).autocomplete('widget').find('a.ui-state-hover')[0]){var j=d.trim(this.value.replace(/\s+/g,' '));w({value:j})}var i=d(this);setTimeout(function(){i.autocomplete('close')},0);return false}}).bind('blur',function(c){d(this).val('').parent().removeClass(b.focusClass)});if(b.ajax||p.length){if(!b.ajax){b.acCfg.minLength=0}e.autocomplete(d.extend({position:{of:e.parent()}},b.acCfg,{source:function(j,i){var r=d.trim(j.term.toLowerCase()).replace(/\s+/g,' ');if(b.ajax){if(b.ajaxMethod){b.ajaxMethod({term:r,input:e,config:b,callback:i})}else{d.ajax({url:B,type:b.ajaxCfg.type,data:C+"="+encodeURIComponent(r),dataType:b.ajaxCfg.dataType,success:function(g){if(b.acFixResults){var h=b.acFixResults(g);g=h===undefined?g:h}g=d.map(g,function(c,f){if(b.acFixItem){b.acFixItem(c)}else{c.id=c.value;c.value=c.tag}delete c.tag;return(d.inArray(c.value.toLowerCase(),l)==-1)?c:null});i(g)}})}}else{var x=[],D=0,s;while((s=p[D++])){var y=s.label.toLowerCase();if(y.indexOf(r)>-1){if(d.inArray(y,l)==-1){x.push(s)}}}i(x)}}})).one('autocompleteopen',function(c,f){e.autocomplete('widget').attr('class',b.acMenuClass)}).bind('autocompleteopen',function(c,f){e.autocomplete('widget').width(e.parent().outerWidth())}).bind('autocompletefocus',function(c,f){return false}).bind('autocompleteselect',function(c,f){w(f.item);if(!b.acCfg.minLength){setTimeout(function(){e.autocomplete('search')},100)}return false});if(!b.acCfg.minLength){e.bind('focus',function(c){e.autocomplete('search')}).autocomplete('search')}}});v(m);m=k=undefined});return this};t.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:true,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
