// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(c){var o=c.fn.dumbTags=function(u){this.each(function(y){var d=c(this),a=c.extend(true,{},o.defaults,u),v=d.closest('[lang]').attr('lang').substr(0.2),m=c.extend({},a.i18n[v]||a.i18n.en),p=d.attr('name'),w=a.ajax&&(('acUrl'in a&&a.acUrl)||d.closest('['+a.acUrlAttr+']',this.form.parentNode).attr(a.acUrlAttr)||c(this.form).attr('action')||''),x=a.ajax&&encodeURIComponent(d.attr(a.acNameAttr)||a.acName||p),h=[],k=[],q=function(f){var g=[];c.each(f,function(e,b){g.push(c(a.tagTempl).text(b.value).append(c('<input type="hidden"/>').attr({name:p,value:b.id||b.value})).append(c(a.tagDelTempl).attr('title',m.delTitle||m.delLabel).html(m.delLabel)).attr('title',b.value)[0])});d.before(g)},r=function(b){var f=b.value.toLowerCase(),g=d.prevAll(a.tagSel).filter(function(){var e=this.title.toLowerCase()!=f;e||c(this).remove();return e});if(a.maxTags&&g.length>=a.maxTags){d.prev(a.tagSel).remove()}q([b]);d.val('')},j;a.splitter=a.splitter||',';if(d.is('select')){if(!('limitVocab'in a)){a.limitVocab=true}j=d;d=c('<input type="text" />').insertAfter(j)}else{j=d.siblings('select')}j.detach().find('option').each(function(){var e=c(this);if(!a.ajax){item={id:e.val(),value:e.text()};item.label=item.value;h.push(item)}if(e.is('[selected]')){k.push({id:e.val(),value:e.text()})}});var n=d.attr('value');if(n){c.each(n.split(a.splitter),function(e,b){b=c.trim(b).replace(/\s+/g,'');if(b){k.push({id:b,value:b})}});if(d.val()==n){d.val('')}}d.attr('name','').wrap(a.wrapperTempl).parent().bind('click',function(e){if(e.target==this){d.trigger('focus')}else if(c(e.target).is(a.delSel)){c(e.target).closest(a.tagSel).remove();return false}}).end().attr('autocomplete','off').bind('focus',function(e){c(this).parent().addClass(a.focusClass)}).one('focus',function(z){d.bind('keypress',function(f){if(!this.value&&f.which==8){var g=c(this);setTimeout(function(){var e=g.prev(a.tagSel),b=e.attr('title');e.find(a.delSel).trigger('click');g.val(b);g[0].select()},0)}else if(f.which==13||f.which==44){if(!a.limitVocab&&this.value){var l=c.trim(this.value.replace(/\s+/g,' '));r({value:l})}c(this).autocomplete('close');return false}}).bind('blur',function(e){c(this).val('').parent().removeClass(a.focusClass)});if(a.ajax||h.length){d.autocomplete(c.extend({position:{of:d.parent()}},a.acCfg,{minLength:a.ajax?a.acCfg.minLength:0,source:function(g,l){var s=c.trim(g.term.toLowerCase()).replace(/\s+/g,' ');if(a.ajax){c.ajax({url:w,type:a.ajaxCfg.type,data:x+"="+encodeURIComponent(s),dataType:a.ajaxCfg.dataType,success:function(f){if(a.acFixResults){f=a.acFixResults(f)}c.each(f,function(e,b){if(a.acFixItem){a.acFixItem(b)}else{b.id=b.value;b.value=b.tag}delete b.tag});l(f)}})}else{var t=[];i=0;while(h[i]){if(h[i].label.toLowerCase().indexOf(s)>-1){t.push(h[i])}i++}l(t)}}})).one('autocompleteopen',function(e,b){d.autocomplete('widget').attr('class',a.acMenuClass)}).bind('autocompleteopen',function(e,b){d.autocomplete('widget').width(d.parent().outerWidth())}).bind('autocompletefocus',function(e,b){return false}).bind('autocompleteselect',function(e,b){r(b.item);return false});if(!a.ajax){d.bind('focus',function(e){d.autocomplete('search')}).autocomplete('search')}}});q(k);k=j=undefined});return this};o.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:1,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
