// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(d){var p=d.fn.dumbTags=function(u){this.each(function(y){var c=d(this),a=d.extend(true,{},p.defaults,u),v=c.closest('[lang]').attr('lang').substr(0.2),m=d.extend({},a.i18n[v]||a.i18n.en),q=c.attr('name'),w=a.ajax&&(('acUrl'in a&&a.acUrl)||c.closest('['+a.acUrlAttr+']',this.form.parentNode).attr(a.acUrlAttr)||d(this.form).attr('action')||''),x=a.ajax&&encodeURIComponent(c.attr(a.acNameAttr)||a.acName||q),h=[],l=[],r=function(f){var g=[];d.each(f,function(e,b){g.push(d(a.tagTempl).text(b.value).append(d('<input type="hidden"/>').attr({name:q,value:b.id||b.value})).append(d(a.tagDelTempl).attr('title',m.delTitle||m.delLabel).html(m.delLabel)).attr('title',b.value)[0])});c.before(g)},s=function(b){var f=b.value.toLowerCase(),g=c.prevAll(a.tagSel).filter(function(){var e=this.title.toLowerCase()!=f;e||d(this).remove();return e});if(a.maxTags&&g.length>=a.maxTags){c.prev(a.tagSel).remove()}r([b]);c.val('')},j;a.splitter=a.splitter||',';if(c.is('select')){if(!('limitVocab'in a)){a.limitVocab=true}j=c;c=d('<input type="text" />').insertAfter(j)}else{j=c.siblings('select')}j.detach().find('option').each(function(){var e=d(this);if(!a.ajax){item={id:e.val(),value:e.text()};item.label=item.value;h.push(item)}if(e.is('[selected]')){l.push({id:e.val(),value:e.text()})}});var n=c.attr('value');if(n){d.each(n.split(a.splitter),function(e,b){b=d.trim(b).replace(/\s+/g,'');if(b){l.push({id:b,value:b})}});if(c.val()==n){c.val('')}}c.attr('name','').wrap(a.wrapperTempl).parent().bind('click',function(e){if(e.target==this){c.trigger('focus')}else if(d(e.target).is(a.delSel)){d(e.target).closest(a.tagSel).remove();return false}}).end().attr('autocomplete','off').bind('focus',function(e){d(this).parent().addClass(a.focusClass)}).one('focus',function(z){c.bind('keypress',function(f){if(!this.value&&f.which==8){var g=d(this);setTimeout(function(){var e=g.prev(a.tagSel),b=e.attr('title');e.find(a.delSel).trigger('click');g.val(b);g[0].select()},0)}else if(f.which==13||f.which==44){if(!a.limitVocab&&this.value){var k=d.trim(this.value.replace(/\s+/g,' '));s({value:k})}d(this).autocomplete('close');return false}}).bind('blur',function(e){d(this).val('').parent().removeClass(a.focusClass)});if(a.ajax||h.length){c.autocomplete(d.extend({position:{of:c.parent()}},a.acCfg,{minLength:a.ajax?a.acCfg.minLength:0,source:function(g,k){var o=d.trim(g.term.toLowerCase()).replace(/\s+/g,' ');if(a.ajax){if(a.ajaxMethod){a.ajaxMethod({term:o,input:c,config:a,callback:k})}else{d.ajax({url:w,type:a.ajaxCfg.type,data:x+"="+encodeURIComponent(o),dataType:a.ajaxCfg.dataType,success:function(f){if(a.acFixResults){f=a.acFixResults(f)}d.each(f,function(e,b){if(a.acFixItem){a.acFixItem(b)}else{b.id=b.value;b.value=b.tag}delete b.tag});k(f)}})}}else{var t=[];i=0;while(h[i]){if(h[i].label.toLowerCase().indexOf(o)>-1){t.push(h[i])}i++}k(t)}}})).one('autocompleteopen',function(e,b){c.autocomplete('widget').attr('class',a.acMenuClass)}).bind('autocompleteopen',function(e,b){c.autocomplete('widget').width(c.parent().outerWidth())}).bind('autocompletefocus',function(e,b){return false}).bind('autocompleteselect',function(e,b){s(b.item);return false});if(!a.ajax){c.bind('focus',function(e){c.autocomplete('search')}).autocomplete('search')}}});r(l);l=j=undefined});return this};p.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:1,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
