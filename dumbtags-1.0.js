// encoding: utf-8
// $.fn.dumbTags 1.0  -- (c) 2012 Hugsmiðjan ehf.
(function(c){var r=c.fn.dumbTags=function(x){this.each(function(C){var d=c(this),a=c.extend(true,{},r.defaults,x),y=d.closest('[lang]').attr('lang').substr(0.2),o=c.extend({},a.i18n[y]||a.i18n.en),s=d.attr('name'),z=a.ajax&&(('acUrl'in a&&a.acUrl)||d.closest('['+a.acUrlAttr+']',this.form.parentNode).attr(a.acUrlAttr)||c(this.form).attr('action')||''),A=a.ajax&&encodeURIComponent(d.attr(a.acNameAttr)||a.acName||s),j=[],m=[],k=[],t=function(g){var h=[];c.each(g,function(b,e){var f={value:e.id||e.value,tag:e.value};k.push(f.tag.toLowerCase());h.push(c(a.tagTempl).text(f.tag).data('dumbTag',f).append(c('<input type="hidden"/>').attr({name:s,value:f.value})).append(c(a.tagDelTempl).attr('title',o.delTitle||o.delLabel).html(o.delLabel))[0])});return c(h).insertBefore(d)},u=function(e){var f=e.value.toLowerCase(),g=d.prevAll(a.tagSel).filter(function(){var b=c(this).data('dumbTag').tag.toLowerCase()==f;if(b){n(this,true)}return!b});if(a.maxTags&&g.length>=a.maxTags){n(d.prev(a.tagSel),true)}var h=t([e]);d.val('');h.trigger('dumbTagAdded')},n=function(b,e){b=c(b);var f=c.Event('dumbTagRemove');f.autoDelete=e;b.trigger(f);if(e||!f.isDefaultPrevented()){var g=c.inArray(b.data('dumbTag').tag.toLowerCase(),k);if(g>-1){k.splice(g,1)}b.remove();return true}return false},l;a.splitter=a.splitter||',';if(d.is('select')){if(!('limitVocab'in a)){a.limitVocab=true}l=d;d=c('<input type="text" />').insertAfter(l)}else{l=d.siblings('select')}l.detach().find('option').each(function(){var b=c(this);if(!a.ajax){item={id:b.val(),value:b.text()};item.label=item.value;j.push(item)}if(b.is('[selected]')){m.push({id:b.val(),value:b.text()})}});var p=d.attr('value');if(p){c.each(p.split(a.splitter),function(b,e){e=c.trim(e).replace(/\s+/g,'');if(e){m.push({id:e,value:e})}});if(d.val()==p){d.val('')}}d.attr('name','').wrap(a.wrapperTempl).parent().bind('click',function(b){if(b.target==this){d.trigger('focus')}else if(c(b.target).is(a.delSel)){n(c(b.target).closest(a.tagSel));return false}}).end().attr('autocomplete','off').bind('focus',function(b){c(this).parent().addClass(a.focusClass)}).one('focus',function(D){d.bind('keypress',function(f){if(!this.value&&f.which==8){var g=c(this);setTimeout(function(){var b=g.prev(a.tagSel),e=b.data('dumbTag').tag;if(n(b)){g.val(e)[0].select()}},0)}else if(f.which==13||f.which==44){if(!a.limitVocab&&this.value){var h=c.trim(this.value.replace(/\s+/g,' '));u({value:h})}c(this).autocomplete('close');return false}}).bind('blur',function(b){c(this).val('').parent().removeClass(a.focusClass)});if(a.ajax||j.length){if(!a.ajax){a.acCfg.minLength=0}d.autocomplete(c.extend({position:{of:d.parent()}},a.acCfg,{source:function(g,h){var q=c.trim(g.term.toLowerCase()).replace(/\s+/g,' ');if(a.ajax){if(a.ajaxMethod){a.ajaxMethod({term:q,input:d,config:a,callback:h})}else{c.ajax({url:z,type:a.ajaxCfg.type,data:A+"="+encodeURIComponent(q),dataType:a.ajaxCfg.dataType,success:function(f){if(a.acFixResults){f=a.acFixResults(f)}f=c.map(f,function(b,e){if(a.acFixItem){a.acFixItem(b)}else{b.id=b.value;b.value=b.tag}delete b.tag;return(c.inArray(b.value.toLowerCase(),k)==-1)?b:null});h(f)}})}}else{var v=[];i=0;while(j[i]){var B=j[i],w=j[i].label.toLowerCase();if(w.indexOf(q)>-1){if(c.inArray(w,k)==-1){v.push(B)}}i++}h(v)}}})).one('autocompleteopen',function(b,e){d.autocomplete('widget').attr('class',a.acMenuClass)}).bind('autocompleteopen',function(b,e){d.autocomplete('widget').width(d.parent().outerWidth())}).bind('autocompletefocus',function(b,e){return false}).bind('autocompleteselect',function(b,e){u(e.item);if(!a.acCfg.minLength){setTimeout(function(){d.autocomplete('search')},100)}return false});if(!a.acCfg.minLength){d.bind('focus',function(b){d.autocomplete('search')}).autocomplete('search')}}});t(m);m=l=undefined});return this};r.defaults={i18n:{en:{delTitle:'Remove this value',delLabel:'x'},is:{delTitle:'Eyða þessu gildi',delLabel:'x'}},wrapperTempl:'<span class="tagswrap"/>',tagTempl:'<span class="tag">',tagDelTempl:'<a href="#" class="del">x</a>',focusClass:'focused',tagSel:'.tag',delSel:'a.del',ajax:1,acUrlAttr:'data-suggesturl',acNameAttr:'data-acname',acMenuClass:'tags-acmenu ui-autocomplete ui-menu',acCfg:{minLength:2,delay:300,html:true},ajaxCfg:{dataType:'json'}}})(jQuery);
