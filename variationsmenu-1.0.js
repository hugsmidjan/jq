// encoding: utf-8
// $.fn.variationsMenu 1.0 -- (c) 2012 Hugsmi√∞jan ehf. 
(function(b){var E=function(f,a){var g,d=f.length,l=-1;varsLoop:while(++l<d){var h=f[l],j=h.length,i=-1;while(++i<j){if(h[i]!=a[i]){continue varsLoop}}g=h;break}return g},F=function(f,a,g){var d={},l=a.length,h=-1;varsLoop:while(++h<l){var j=a[h],i=j.length,e=-1;while(++e<i){if(g[e]!==undefined&&e!=f&&j[e]!=g[e]){continue varsLoop}}d[j[f]]=true}return d};b.fn.variationsMenu=function(c){c=b.extend({imgCont:'.imagelist',imgItems:'>*',imgContOnClass:'variated',imgOnClass:'active',tagJoint:'-',wrapper:'<fieldset class="variationsmenu"><i headline/><i menus/></fieldset>',wrapperHl:'<h3/>',menuTmpl:'<fieldset class="fi_rdo req"><h4>{legend}</h4><ul><li items/></ul></fieldset>',menuItem:'<li class="{value}"><input type="radio" name="{tagname}" value="{value}" id="{id}" /><label for="{id}">{label}</label></li>',emptyLabel:'--',currentClass:'current',disabledClass:'disabled'},c);var G=[];this.each(function(){var q=b(this),n=q.find('select'),H=b(c.imgCont).addClass(c.imgContOnClass),z=q.find('label').contents(),v=(new Date()).getTime(),I=b('<input type="hidden" />').attr({name:n[0].name}),r=(n.attr('data-tagnames')||'').split('|'),A=(n.attr('data-taglabels')||'').split('|'),B=r.length,C=new RegExp('\s*'+(n.attr('data-tagjoint')||c.tagJoint)+'\s*'),w=[],o,p=[],s=b.map(r,function(f,a){return{name:r[a],legend:A[a],vals:{},tagData:{}}});n.children().each(function(f){var a=b(this),g=a.attr('value');if(g){var d=a.text().split(C),l=a.attr('data-tags').split('|'),h=a.attr('data-tagdata'),j=a.is(':selected'),i=[];h=h?h.split('|'):[];i.id=g;for(var e=0;e<B;e++){var k=l[e]||'';i.push(k);s[e].vals[k]=d[e]||c.emptyLabel;s[e].tagData[k]=h[e];j&&(p[e]=k)}if(j){o=i}w.push(i)}});var x=b.map(s,function(m,y){var D=b(c.menuTmpl.replace(/\{legend\}/g,m.legend)).addClass(m.name),J=0,t,u=b.map(m.vals,function(f,a){var g=c.menuItem.replace(/\{id\}/g,m.name+v+'-'+(J++)).replace(/\{tagname\}/g,m.name+v).replace(/\{label\}/g,f).replace(/\{value\}/g,a),d=b(g).data('varValue',a);if(a==p[y]){d.addClass(c.currentClass).find('input').prop('checked',true);t=d[0]}if(c.itemBuilder){d=c.itemBuilder(d,m.name,m.tagData[a],a,f)||d}return d.toArray()});u=b(u).on('click.variationmenu',function(j,i){var e=this,k=b(e);if(i||(t!=e&&!k.data('varDisabled'))){if(!i||k.is('.'+c.currentClass)){if(b(j.target).closest('[href]',e)[0]){j.preventDefault()}b(t).removeClass(c.currentClass);t=e;p[y]=k.addClass(c.currentClass).find('input').prop('checked',true).end().data('varValue');o=E(w,p);b(x).data('selectedvariation',o).each(function(g){var d=F(g,w,p);b(this).data('varMenuItems').each(function(){var f=b(this),a=!d[f.data('varValue')];f.toggleClass(c.disabledClass,a).data('varDisabled',a).find('input:radio, button').prop('disabled',a)})})}H.each(function(){var l=b(this).find(c.imgItems),h=[];activeImgs=l.filter(function(){var f=b(this),a=f.attr('data-forvariation'),g=o&&o.id,d=a?b.inArray(g,a.split('|'))>-1:!g;!a&&h.push(f[0]);f.toggleClass(c.imgOnClass,d);d&&f.trigger('variationImageActive');return d});if(!activeImgs.length){b(h).addClass(c.imgOnClass)}});!i&&k.trigger('variationchanged',[o,m.name,p[y]])}});D.data('varMenuItems',u).find('[items]').replaceWith(u);return D.toArray()});var K=b(c.wrapper);K.find('[headline]').replaceWith(b(c.wrapperHl).append(z)).end().find('[menus]').replaceWith(x).end().replaceAll(q).after(I);b(x[0]).data('varMenuItems').filter(':first, .'+c.currentClass).last().triggerHandler('click.variationmenu',[true]);r=A=B=C=s=q=n=z=v=undefined});return this.pushStack(K)}})(jQuery);
