// $.fn.variationsMenu 1.0 -- (c) 2012 Hugsmi√∞jan ehf.
(function(b){var H=function(d,a){var g,e=d.length,j=-1;varsLoop:while(++j<e){var h=d[j],l=h.length,k=-1;while(++k<l){if(h[k]!=a[k]){continue varsLoop}}g=h;break}return g},I=function(d,a,g){var e={},j=a.length,h=-1;varsLoop:while(++h<j){var l=a[h],k=l.length,f=-1;while(++f<k){if(g[f]!==undefined&&f!=d&&l[f]!=g[f]){continue varsLoop}}e[l[d]]=true}return e};b.fn.variationsMenu=function(c){c=b.extend({imgCont:'.imagelist',imgItems:'>*',imgContOnClass:'variated',imgOnClass:'active',imgOnBuilder:function(d){if(!d.is('.image')){var a=d.find('a');d.addClass('image');a.addClass('img');b('<img/>').attr({src:a.attr('data-img'),alt:a.text()}).appendTo(a.empty())}},imgClickFirst:!!b.fn.bigimgSwitcher,tagJoint:' - ',wrapper:'<fieldset class="variationsmenu"><i headline/><i menus/></fieldset>',wrapperHl:'<h3/>',menuTmpl:'<fieldset class="fi_rdo req"><h4>{legend}</h4><ul><li items/></ul></fieldset>',menuItem:'<li class="{value}"><input type="radio" name="{tagname}" value="{value}" id="{id}" /><label for="{id}">{label}</label></li>',emptyLabel:'--',currentClass:'current',i18n:{is:{unavail:' (Samsetning ekki til)'},en:{unavail:' (Combination unavailable)'}},disabledClass:'disabled'},c);var A=[];this.each(function(){var q=b(this),p=q.find('select'),J=b(c.imgCont).addClass(c.imgContOnClass),B=q.find('label').contents(),w=(new Date()).getTime(),K=c.i18n[q.closest('[lang]').attr('lang')]||c.i18n.en,C=b('<input type="hidden" />').attr({name:p[0].name}),r=(p.attr('data-tagnames')||'').split('|'),D=(p.attr('data-taglabels')||'').split('|'),E=r.length,F=new RegExp('\\s*'+(p.attr('data-tagjoint')||c.tagJoint)+'\\s*'),x=[],m,o=[],s=b.map(r,function(d,a){return{name:r[a],legend:D[a],vals:{},tagData:{}}});p.children().each(function(d){var a=b(this),g=a.attr('value');if(g){var e=a.text().split(F),j=a.attr('data-tags').split('|'),h=a.attr('data-tagdata'),l=a.is(':selected'),k=[];h=h?h.split('|'):[];k.id=g;for(var f=0;f<E;f++){var i=j[f]||'';k.push(i);s[f].vals[i]=e[f]||c.emptyLabel;s[f].tagData[i]=h[f];l&&(o[f]=i)}if(l){m=k}x.push(k)}});var y=b.map(s,function(n,t){var G=b(c.menuTmpl.replace(/\{legend\}/g,n.legend)).addClass(n.name),L=0,u,v=b.map(n.vals,function(d,a){var g=c.menuItem.replace(/\{id\}/g,n.name+w+'-'+(L++)).replace(/\{tagname\}/g,n.name+w).replace(/\{label\}/g,d).replace(/\{value\}/g,a),e=b(g).data('varValue',a),j=a==o[t];if(j){e.addClass(c.currentClass).find('input').prop('checked',true)}if(c.itemBuilder){e=c.itemBuilder(e,n.name,n.tagData[a],a,d)||e}e=e[0];e.orgTitle=d;if(j){u=e}return e});v=b(v).on('click.variationmenu',function(k,f){var i=b(this),M=i.find('input');if(f||u!=i[0]){if(!f||i.is('.'+c.currentClass)){if(b(k.target).closest('[href]',i[0])[0]){k.preventDefault()}b(u).removeClass(c.currentClass);u=i[0];if(i.data('varDisabled')){o=[]}o[t]=i.data('varValue');m=H(x,o);i.removeClass(c.disabledClass).data('varDisabled',false).addClass(c.currentClass);M.prop('checked',true).attr('title',i[0].orgTitle);b(y).data('selectedvariation',m).each(function(e){if(e!=t){var j=I(e,x,o);b(this).data('varMenuItems').each(function(){var d=b(this),a=d.find('input'),g=!j[d.data('varValue')];d.toggleClass(c.disabledClass,g).data('varDisabled',g);a.attr('title',this.orgTitle+(g?K.unavail:''));if(g&&a.prop('checked')){a.prop('checked',false);d.removeClass(c.currentClass)}})}})}J.each(function(){var j=b(this).find(c.imgItems),h=[],l=j.filter(function(){var d=b(this),a=d.attr('data-forvariation'),g=m&&m.id,e=a?b.inArray(g,a.split('|'))>-1:!g;!a&&h.push(d[0]);d.toggleClass(c.imgOnClass,e);if(e&&!d.data('variationinited')){c.imgOnBuilder&&c.imgOnBuilder(d);d.trigger('variationImageActive').data('variationinited',true)}return e});if(!l[0]){b(h).addClass(c.imgOnClass)}if(c.imgClickFirst&&(l[0]||!f)){b(l[0]||h[0]).trigger('click')}});!f&&i.trigger('variationchanged',[m,n.name,o[t]]);C.val(m?m.id:'')}});G.data('varMenuItems',v).find('[items]').replaceWith(v);return G.toArray()});var z=b(c.wrapper);A.push(z[0]);z.find('[headline]').replaceWith(b(c.wrapperHl).append(B)).end().find('[menus]').replaceWith(y).end().replaceAll(q).after(C);b(y[0]).data('varMenuItems').filter(':first, .'+c.currentClass).last().triggerHandler('click.variationmenu',[true]);r=D=E=F=s=q=p=B=w=z=undefined});return this.pushStack(A)}})(jQuery);
