// encoding: utf-8
// $.fn.filterTable 1.0  -- (c) 2009 Hugsmi√∞jan ehf. 
(function(c,T){var M=function(f){var f=c(f).filter('table').eq(0);if(!f.find('thead').length){var d=f.find('tbody'),g=c('<thead />').insertBefore(d[0]),j=d.find('tr'),i;j.each(function(a){var b=c(this),e=b.find('td');if((b.find('th').length&&(!e.length||a===0))||w(e)){b.appendTo(g);return}return false})}};var s=function(){},x=c.beget||function(a,b){s.prototype=a;return b?c.extend(new s,b):new s},w=function(a){return!c(a).clone().find('>b, >strong').remove().end().text().replace(/\s/g,'')},y=function(a){a=c(a);return{cols:parseInt('0'+a.attr('colspan'),10)||1,rows:parseInt('0'+a.attr('rowspan'),10)||1}},N=function(a){c(this).data(m).input.val('').trigger('change').trigger('focus');a.stopPropagation()},O=function(a){this.select()},P=function(a){var b=c(this);b.closest('td, th').toggleClass(b.data(m).cfg.fieldFocusClass,a.type=='focus')},t=function(b,e,f){c(b).each(function(){var a=c(this);if(e.hideRowClass){a.toggleClass(e.hideRowClass,f)}else if(f){a.css('display','')}else{a.hide()}})},z=function(a,b){t(a,b,1)},Q=function(a,b){t(a,b,0)},R=function(a){var b=c(this),e=b.data(m);clearTimeout(e._0);if(a.type=='change'){A(b)}else{e._0=setTimeout(function(){A(b)},e.cfg.delay)}},A=function(f){var d=f.val(),g=f.data(m),j=g.lastValue,i=g.table,h=g.cfg,o=g.btn,k=h.activeColClass,l;delete g._0;if(d&&!j){l=1;if(!h.multiFilter){g.allInputs.not(f).each(function(a){var b=this,e=c(b).data(m);if(b.value){this.value=e.lastValue='';B(i,e.idx,k,0)}})}}else if(!d&&j){l=1}g.lastValue=d;if(l){B(i,g.idx,k,!!d)}if(d!=j){S(g)}i.useCellMapCache=0},S=function(i){C(i.table);var h=i.cfg,o=i.table.find('tbody'),k=o.find('tr'),l;if(h.isStickyRow){k=k.filter(function(){var a=c(this).filter(h.isStickyRow);z(a,h);return!a.length})}if(h.isHideRow){k=k.filter(function(){var a=c(this).filter(h.isHideRow);Q(a,h);return!a.length})}i.allInputs.each(function(f){var d=c(this),g=d.data(m);if(g.lastValue){l=1;var j=c.trim(this.value);j=h.matchCase?j:j.toLowerCase();k.each(function(){var a=c(this),b=a.data(u),e=b[f];t(a,h,(e&&h.cellMatches(e,j,g)))});k=k.filter(':visible')}});if(!l){z(o.find('tr'),h)}i.table.toggleClass(h.activeTableClass,l).trigger('filter.filterTable')},C=function(i){if(!i.useCellMapCache){var h=[];c(i).find('tr').each(function(){var f=c(this),d=0,g,j=[];f.data(u,j).children().each(function(){while(h[d]){h[d++]--}var a=this,b=y(a),e=b.cols;j[d]=a;while(e--){h[d]=b.rows-1;d++}});j.length=d});i.useCellMapCache=1}},B=function(a,b,e,f){C(a);var d=c(a).find('tr'),g=d.map(function(){return c(this).data(u)[b]||null});g.toggleClass(e,f)},U,V,W,X,Y,m='filterTable',u=m+'-cellMap',q=!0;c.fn.filterTable=function(n){if(this.length){var D=this.filter('table').add(this.find('table'));if(D.length){n=x(arguments.callee.defaults,n);var E=E||c(n.filterRow),F=F||c(n.inputField).bind('focus',O).bind('focus blur',P).bind('change keyup',R),G=G||c(n.clearBtn).bind('click',N),v=v||c(n.filterCell),H=H||v.clone(q).empty().append(F);D.each(function(){M(this);var i=c(this),h=i.find('tbody tr'),o=i.find('thead'),k=o.find('tr'),l=E.clone(q),Z,I=!k.length,J={cfg:n,table:i},p=[],r=[];k=I?h.eq(0):k;k.each(function(){var d=0,g=c.browser,j=g.msie&&parseInt(g.version,10);c('>*',this).each(function(a,b){while(r[d]){r[d++]--}var e=y(b),f=e.cols;j&&c(b).attr('rowspan',e.rows);p[d]=b;while(f--){p[d]=p[d]||b;r[d]=e.rows-1;d++}})});p=c(p).each(function(a){var b=c(this);if(r[a]){b.attr('rowspan',k.length)}var e=G.clone(q),f=x(J,{idx:a,btn:e}),d=((b.filter(n.includeCols).length||I)?H:v).clone(q),g=d.appendTo(l).find('input').data(m,f).after(e);e.data(m,{input:g})});J.allInputs=l.find('input');l.appendTo(o);if(n.fixColWidths){var K=[],L=0;l.find('>*').each(function(a){var b=parseInt(c(this).width(),10);K[a]=b;L+=b}).each(function(a){c(this).width((100*K[a]/L)+'%')})}})}}return this};c.fn.filterTable.defaults={fixColWidths:true,filterRow:'<tr class="filters" />',filterCell:'<td>&nbsp;</td>',inputField:'<input />',clearBtn:'<span class="clearfilter"/>',activeTableClass:'filters-active',fieldFocusClass:'filter-focus',activeColClass:'filter-col',includeCols:function(){return c(this).is('th')||w(this)},cellMatches:function(a,b,e){var f=c(a).text()||'',d=e.cfg,g;f=d.matchCase?f:f.toLowerCase();g=f.indexOf(b);return d.substrSearch?g>-1:!g},substrSearch:true,delay:300}})(jQuery);
