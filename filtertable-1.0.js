// $.fn.filterTable 1.0  -- (c) 2009 HugsmiÃ°jan ehf.
(function(t,e){var a=8>parseInt((/MSIE ([\w.]+)/.exec(navigator.userAgent)||[])[1],10);var i=function(e,a){var e=t(e).filter("table").eq(0);if(!a.thead&&!e.find("thead").length){var i=e.find("tbody"),n=t("<thead />").insertBefore(i[0]),l=i.find("tr"),r;l.each(function(e){var a=t(this),i=a.find("td");if(a.find("th").length&&(!i.length||e===0)||s(i)){a.appendTo(n);return}return false})}};var n=function(){},l=t.beget||function(e,a){n.prototype=e;return a?t.extend(new n,a):new n},s=function(e){return!t(e).clone().find(">b, >strong").remove().end().text().replace(/\s/g,"")},r=function(e){e=t(e);return{cols:parseInt("0"+e.attr("colspan"),10)||1,rows:parseInt("0"+e.attr("rowspan"),10)||1}},f=function(e){t(this).data(I).input.val("").trigger("change").trigger("focus");e.stopPropagation()},c=function(t){this.select()},o=function(e){var a=t(this);a.closest("td, th").toggleClass(a.data(I).cfg.fieldFocusClass,e.type=="focus")},u=function(e,a,i){t(e).each(function(){var e=t(this);if(a.hideRowClass){e.toggleClass(a.hideRowClass,i)}else if(i){e.css("display","")}else{e.hide()}})},d=function(t,e){u(t,e,1)},h=function(t,e){u(t,e,0)},g=function(e){var a=t(this),i=a.data(I);clearTimeout(i._searchThread);if(e.type=="change"){v(a)}else{i._searchThread=setTimeout(function(){v(a)},i.cfg.delay)}},v=function(e){var a=e.val(),i=e.data(I),n=i.lastValue,l=i.table,s=i.cfg,r=i.btn,f=s.activeColClass,c;delete i._searchThread;if(a&&!n){c=1;if(!s.multiFilter){i.allInputs.not(e).each(function(e){var a=this,i=t(a).data(I);if(a.value){this.value=i.lastValue="";C(l,i.idx,f,0)}})}}else if(!a&&n){c=1}i.lastValue=a;if(c){C(l,i.idx,f,!!a)}if(a!=n){p(i)}l.useCellMapCache=0},p=function(e){b(e.table);var a=e.cfg,i=e.table.find("tbody"),n=i.find("tr"),l;if(a.isStickyRow){n=n.filter(function(){var e=t(this).filter(a.isStickyRow);d(e,a);return!e.length})}if(a.isHideRow){n=n.filter(function(){var e=t(this).filter(a.isHideRow);h(e,a);return!e.length})}e.allInputs.each(function(e){var i=t(this),s=i.data(I);if(s.lastValue){l=1;var r=t.trim(this.value);r=a.matchCase?r:r.toLowerCase();n.each(function(){var i=t(this),n=i.data(M),l=n[e];u(i,a,l&&a.cellMatches(l,r,s))});n=n.filter(":visible")}});if(!l){d(i.find("tr"),a)}e.table.toggleClass(a.activeTableClass,l).trigger("filter.filterTable")},b=function(e){if(!e.useCellMapCache){var a=[];t(e).find("tr").each(function(){var e=t(this),i=0,n,l=[];e.data(M,l).children().each(function(){while(a[i]){a[i++]--}var t=this,e=r(t),n=e.cols;l[i]=t;while(n--){a[i]=e.rows-1;i++}});l.length=i});e.useCellMapCache=1}},C=function(e,a,i,n){b(e);var l=t(e).find("tr"),s=l.map(function(){return t(this).data(M)[a]||null});s.toggleClass(i,n)},w,y,T,m,x,I="filterTable",M=I+"-cellMap",R=!0;t.fn.filterTable=function(e){var n=!!arguments.callee.debugMode;if(this.length){var s=this.filter("table").add(this.find("table"));if(s.length){e=l(arguments.callee.defaults,e);var u=u||t(e.filterRow),d=d||t(e.inputField).bind("focus",c).bind("focus blur",o).bind("change keyup",g),h=h||t(e.clearBtn).bind("click",f),v=v||t(e.filterCell),p=p||v.clone(R).empty().append(d);s.each(function(){i(this,e);var s=t(this),f=s.find("tbody tr"),c=e.thead?t(e.thead):s.find("thead"),o=c.find("tr"),d=u.clone(R),g,b=!o.length,C={cfg:e,table:s},w=[],y=[];o=b?f.eq(0):o;o.each(function(){var e=0;t(">*",this).each(function(i,n){while(y[e]){y[e++]--}var l=r(n),s=l.cols;a&&t(n).attr("rowspan",l.rows);w[e]=n;while(s--){w[e]=w[e]||n;y[e]=l.rows-1;e++}})});w=t(w).each(function(a){var i=t(this);if(y[a]){i.attr("rowspan",o.length)}var n=h.clone(R),s=l(C,{idx:a,btn:n}),r=(i.filter(e.includeCols).length||b?p:v).clone(R),f=r.appendTo(d).find("input").data(I,s).after(n);n.data(I,{input:f})});C.allInputs=d.find("input");d.appendTo(c);if(e.fixColWidths){var T=[],m=0;d.find(">*").each(function(e){var a=parseInt(t(this).width(),10);T[e]=a;m+=a}).each(function(e){t(this).width(100*T[e]/m+"%")})}if(n){s.addClass("tablefilters-debug");w.addClass("debug-activeHeader").each(function(e){t(this).append(" ("+(e+1)+")")});window.console&&console.log([s[0]],"colHeaders: ",w)}})}}return this};t.fn.filterTable.defaults={fixColWidths:true,filterRow:'<tr class="filters" />',filterCell:"<td>&nbsp;</td>",inputField:"<input />",clearBtn:'<span class="clearfilter"/>',activeTableClass:"filters-active",fieldFocusClass:"filter-focus",activeColClass:"filter-col",includeCols:function(){return t(this).is("th")||s(this)},cellMatches:function(e,a,i){var n=t(e).text()||"",l=i.cfg,s;n=l.matchCase?n:n.toLowerCase();s=n.indexOf(a);return l.substrSearch?s>-1:!s},substrSearch:true,delay:300}})(jQuery);
