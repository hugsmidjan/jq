// $.fn.fickle 2.0  -- (c) 2009-2012 Hugsmi√∞jan ehf.
(function(e,n,o){var i="fickle",t=i+"-"+e.aquireId(),c,s,f=function(){clearTimeout(c)},u=function(n,o,t){var c=e.Event(i+o);c.cfg=t;n.trigger(c);return!c.isDefaultPrevented()},r={open:function(i,c){var s=i.c;s.opener=c&&c.opener||s.opener;if(!i._isOpen&&u(this,"open",s)){if(!e("#"+t)[0]){e('<i id="'+t+'" tabindex="0" style="position:fixed;_position:absolute;left:-9999px;overflow:hidden;margin-top:-1px;width:1px;height:1px;"> </i>').appendTo("body")}var f=s.focusElm,r=f?f.charAt?this.find(f):f:[];i._gotFocus=o;s.fickle&&e(n).on("focusin click",i._confirmFocusLeave);s.closeOnEsc&&e(n).on("keydown",i._listenForEsc);i._isOpen=!0;s.fadein&&this.fadeIn(s.fadein);this.queue(function(){var n=e(this);n.unhide();u(n,"opened",s);if(!i._gotFocus){var t=c&&c.silent!==o?c.silent:s.silent;if(!t){e.focusHere(r[0]||this)}}n.dequeue()})}},close:function(i,t){var c=i.c;if(i._isOpen&&u(this,"close",c)){e(n).off("focusin click",i._confirmFocusLeave).off("keydown",i._listenForEsc);var s=t&&t.silent!==o?t.silent:c.silent;if(!s){e.focusHere(c.opener||n.body)}i._isOpen=!1;c.fadeout&&this.fadeOut(c.fadeout);this.queue(function(){var n=e(this);n.hide();u(n,"closed",c);n.dequeue()})}},toggle:function(e,n){var i=typeof n==="boolean"?n:n&&n.doOpen!==o?n.doOpen:!e._isOpen;r[i?"open":"close"].call(this,e,n)},isOpen:function(e){return!!(e&&e._isOpen)},isFickle:function(e){return!!e},config:function(e){return e&&e.c},destroy:function(o){e(n).off("focusin click",o._confirmFocusLeave).off("keydown",o._listenForEsc);this.off("."+t).removeData(t)}},a={fickle:!0,closeOnEsc:!0,closeDelay:300};e.fn.fickle=function(n,o){var u=this;if(typeof n==="string"){var l=r[n];if(l){return/^(?:config|is(?:Open|Fickle))$/.test(n)?l(u.data(t)):u.each(function(n,i){i=e(i);var c=i.data(t);c&&l.call(i,c,o)})}}else{n=e.beget(a,n);u.each(function(){var o=e(this);o.data(t)&&o.fickle("destroy");e.each(["Open","Opened","Close","Closed"],function(e,c){var s=i+c.toLowerCase()+"."+t,f=n["on"+c];!n.bubble&&o.on(s,function(e){e.stopPropagation()});f&&o.on(s,f)});var u={c:e.beget(n),_listenForEsc:function(e){return e.which!==27||o.fickle("close")&&false},_confirmFocusLeave:function(n){var i=o[0];s=n.target!==i&&!e.contains(i,n.target)}},r;!n.startOpen&&o.hide();o.data(t,u).on("focusin."+t+" focusout."+t,function(e){u._gotFocus=e.type==="focusin"});if(n.fickle){o.on("focusout."+t,function(){var o=this;f();s=false;c=setTimeout(function(){n.trapFocus?e.focusHere(r):s&&e(o).fickle("close")},n.trapFocus?0:n.closeDelay)}).on("click."+t+" mousedown."+t+" focusin."+t,function(n){setTimeout(f,0);if(n.type==="click"){var o=e(this);o.one("mouseleave."+t,function(){u._isOpen&&e.focusHere(r)})}else if(n.type==="focusin"){r=n.target}})}if(n.startOpen){o.fickle("open")}})}return u}})(jQuery,document);
