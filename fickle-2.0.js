// $.fn.fickle 2.0  -- (c) 2009-2012 Hugsmi√∞jan ehf.
(function(d,k){var l=function(a,b,c){var e=d.Event(n+b);e.cfg=c;a.trigger(e);return!e.isDefaultPrevented()},m=document,n='fickle',q,o,r=function(){clearTimeout(q)},s={open:function(c,e){var g=c.c;g.opener=(e&&e.opener)||g.opener;if(!c._0&&l(this,'open',g)){var f=d('#'+h);if(!f[0]){f=d('<i id="'+h+'" tabindex="0" style="position:fixed;_4:absolute;left:-9999px;overflow:hidden;margin-top:-1px;width:1px;height:1px;"> </i>')}d('body').append(f);var i=g.focusElm,j=i?(i.charAt?this.find(i):i):[];c._1=k;g.fickle&&d(m).on('focusin click',c._2);g.closeOnEsc&&d(m).on('keydown',c._3);c._0=!0;g.fadein&&this.fadeIn(g.fadein);this.queue(function(){var a=d(this);a.unhide();l(a,'opened',g);if(!c._1){var b=(e&&e.silent!==k)?e.silent:g.silent;if(!b){d.focusHere(j[0]||this)}}a.dequeue()})}},close:function(b,c){var e=b.c;if(b._0&&l(this,'close',e)){d(m).off('focusin click',b._2).off('keydown',b._3);var g=(c&&c.silent!==k)?c.silent:e.silent;if(!g){d.focusHere(e.opener||m.body)}b._0=!1;e.fadeout&&this.fadeOut(e.fadeout);this.queue(function(){var a=d(this);a.hide();l(a,'closed',e);a.dequeue()})}},toggle:function(a,b){var c=typeof b==='boolean'?b:b&&b.doOpen!==k?b.doOpen:!a._0;s[c?'open':'close'].call(this,a,b)},isOpen:function(a){return!!(a||a._0)},isFickle:function(a){return!!a},config:function(a){return a&&a.c}},t={fickle:!0,closeOnEsc:!0,closeDelay:300},h=n+'-'+d.aquireId();d.fn.fickle=function(f,i){var j=this;if(typeof f==='string'){var p=s[f];if(p){return(/^(?:config|is(?:Open|Fickle))$/.test(f))?p(j.data(h)):j.each(function(a,b){b=d(b);var c=b.data(h);c&&p.call(b,c,i)})}}else{f=d.beget(t,f);j.each(function(){var c=d(this);if(!c.data(h)){d.each(['Open','Opened','Close','Closed'],function(a,b){f['on'+b]&&c.on(n+b.toLowerCase(),f['on'+b])});var e={c:d.beget(f),_3:function(a){return(a.which!==27)||c.fickle('close')&&false},_2:function(a){var b=c[0];o=a.target!==b&&!d.contains(b,a.target)}},g;!f.startOpen&&c.hide();c.data(h,e).on('focusin focusout',function(a){e._1=a.type==='focusin'});if(f.fickle){c.on('focusout',function(){var a=this;r();o=false;q=setTimeout(function(){f.trapFocus?d.focusHere(g):o&&d(a).fickle('close')},f.trapFocus?0:f.closeDelay)}).on('click mousedown focusin',function(a){setTimeout(r,0);if(a.type==='click'){var b=d(this);b.one('mouseleave',function(){e._0&&d.focusHere(g)})}else if(a.type==='focusin'){g=a.target}})}if(f.startOpen){c.fickle('open')}}})}return j}})(jQuery);
