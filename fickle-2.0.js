// $.fn.fickle 2.0  -- (c) 2009-2012 Hugsmi√∞jan ehf.
(function(d,j,k){var n='fickle',f=n+'-'+d.aquireId(),q,o,r=function(){clearTimeout(q)},l=function(a,b,e){var c=d.Event(n+b);c.cfg=e;a.trigger(c);return!c.isDefaultPrevented()},s={open:function(e,c){var g=e.c;g.opener=(c&&c.opener)||g.opener;if(!e._0&&l(this,'open',g)){if(!d('#'+f)[0]){d('<i id="'+f+'" tabindex="0" style="position:fixed;_4:absolute;left:-9999px;overflow:hidden;margin-top:-1px;width:1px;height:1px;"> </i>').appendTo('body')}var i=g.focusElm,h=i?(i.charAt?this.find(i):i):[];e._3=k;g.fickle&&d(j).on('focusin click',e._1);g.closeOnEsc&&d(j).on('keydown',e._2);e._0=!0;g.fadein&&this.fadeIn(g.fadein);this.queue(function(){var a=d(this);a.unhide();l(a,'opened',g);if(!e._3){var b=(c&&c.silent!==k)?c.silent:g.silent;if(!b){d.focusHere(h[0]||this)}}a.dequeue()})}},close:function(b,e){var c=b.c;if(b._0&&l(this,'close',c)){d(j).off('focusin click',b._1).off('keydown',b._2);var g=(e&&e.silent!==k)?e.silent:c.silent;if(!g){d.focusHere(c.opener||j.body)}b._0=!1;c.fadeout&&this.fadeOut(c.fadeout);this.queue(function(){var a=d(this);a.hide();l(a,'closed',c);a.dequeue()})}},toggle:function(a,b){var e=typeof b==='boolean'?b:b&&b.doOpen!==k?b.doOpen:!a._0;s[e?'open':'close'].call(this,a,b)},isOpen:function(a){return!!(a&&a._0)},isFickle:function(a){return!!a},config:function(a){return a&&a.c},destroy:function(a){d(j).off('focusin click',a._1).off('keydown',a._2);this.off('.'+f).removeData(f)}},t={fickle:!0,closeOnEsc:!0,closeDelay:300};d.fn.fickle=function(h,u){var m=this;if(typeof h==='string'){var p=s[h];if(p){return(/^(?:config|is(?:Open|Fickle))$/.test(h))?p(m.data(f)):m.each(function(a,b){b=d(b);var e=b.data(f);e&&p.call(b,e,u)})}}else{h=d.beget(t,h);m.each(function(){var c=d(this);c.data(f)&&c.fickle('destroy');d.each(['Open','Opened','Close','Closed'],function(a,b){var e=h['on'+b];e&&c.on(n+b.toLowerCase()+'.'+f,e)});var g={c:d.beget(h),_2:function(a){return(a.which!==27)||c.fickle('close')&&false},_1:function(a){var b=c[0];o=a.target!==b&&!d.contains(b,a.target)}},i;!h.startOpen&&c.hide();c.data(f,g).on('focusin.'+f+' focusout.'+f,function(a){g._3=a.type==='focusin'});if(h.fickle){c.on('focusout.'+f,function(){var a=this;r();o=false;q=setTimeout(function(){h.trapFocus?d.focusHere(i):o&&d(a).fickle('close')},h.trapFocus?0:h.closeDelay)}).on('click.'+f+' mousedown.'+f+' focusin.'+f,function(a){setTimeout(r,0);if(a.type==='click'){var b=d(this);b.one('mouseleave.'+f,function(){g._0&&d.focusHere(i)})}else if(a.type==='focusin'){i=a.target}})}if(h.startOpen){c.fickle('open')}})}return m}})(jQuery,document);
