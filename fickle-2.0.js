// encoding: utf-8
// $.fn.fickle 2.0  -- (c) 2009-2012 Hugsmi√∞jan ehf.
(function(d,j){var k=function(b,a,e){var c=d.Event(n+a);c.cfg=e;b.trigger(c);return!c.isDefaultPrevented()},l=document,n='fickle',q,o,r=function(b){clearTimeout(q)},s={open:function(e,c){var g=e.c;g.opener=(c&&c.opener)||g.opener;if(!e._0&&k(this,'open',g)){var h=d('#'+i);if(!h[0]){h=d('<i id="'+i+'" tabindex="0" style="position:fixed;_4:absolute;left:-9999px;overflow:hidden;margin-top:-1px;width:1px;height:1px;"> </i>')}d('body').append(h);var f=g.focusElm;focusTarget=f?(f.charAt?this.find(f):f):[];e._1=j;g.fickle&&d(l).on('focusin click',e._2);g.closeOnEsc&&d(l).on('keydown',e._3);e._0=!0;g.fadein&&this.fadeIn(g.fadein);this.queue(function(){var b=d(this);b.unhide();k(b,'opened',g);if(!e._1){var a=(c&&c.silent!==j)?c.silent:g.silent;if(!a){d.focusHere(focusTarget[0]||this)}}b.dequeue()})}},close:function(a,e){var c=a.c;if(a._0&&k(this,'close',c)){d(l).off('focusin click',a._2).off('keydown',a._3);var g=(e&&e.silent!==j)?e.silent:c.silent;if(!g){d.focusHere(c.opener||l.body)}a._0=!1;c.fadeout&&this.fadeOut(c.fadeout);this.queue(function(){var b=d(this);b.hide();k(b,'closed',c);b.dequeue()})}},toggle:function(b,a){var e=typeof a=='boolean'?a:a&&a.doOpen!==j?a.doOpen:!b._0;s[e?'open':'close'].call(this,b,a)},isOpen:function(b){return!!(b||b._0)},isFickle:function(b){return!!b},config:function(b){return b&&b.c}},t={fickle:!0,closeOnEsc:!0,closeDelay:300},i=n+'-'+d.aquireId();d.fn.fickle=function(f,u){var m=this;if(typeof f=='string'){var p=s[f];if(p){return(/^(?:config|is(?:Open|Fickle))$/.test(f))?p(m.data(i)):m.each(function(b,a){a=d(a);var e=a.data(i);e&&p.call(a,e,u)})}}else{f=d.beget(t,f);m.each(function(){var c=d(this);if(!c.data(i)){d.each(['Open','Opened','Close','Closed'],function(b,a){f['on'+a]&&c.on(n+a.toLowerCase(),f['on'+a])});var g={c:d.beget(f),_3:function(b){return(b.which!=27)||c.fickle('close')&&false},_2:function(b){var a=c[0];o=b.target!=a&&!d.contains(a,b.target)}},h;!f.startOpen&&c.hide();c.data(i,g).on('focusin focusout',function(b){g._1=b.type=='focusin'});if(f.fickle){c.on('focusout',function(b){var a=this;r();o=false;q=setTimeout(function(){f.trapFocus?d.focusHere(h):o&&d(a).fickle('close')},f.trapFocus?0:f.closeDelay)}).on('click mousedown focusin',function(a){setTimeout(r,0);if(a.type=='click'){var e=d(this);e.one('mouseleave',function(b){g._0&&d.focusHere(h)})}else if(a.type=='focusin'){h=a.target}})}if(f.startOpen){c.fickle('open')}}})}return m}})(jQuery);
